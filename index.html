<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Siswa - SMP Diponegoro Sampang</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Charts for 3D graphs -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS (xlsx) for Excel file reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .sidebar-item.active {
            background-color: #1e3a8a; /* A darker blue for active state */
            color: white;
            border-left: 4px solid #facc15; /* Yellow accent */
        }
        .hidden {
            display: none;
        }
        .page {
           animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Style for file input */
        input[type="file"]::file-selector-button {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #1d4ed8;
        }
        /* Mengubah kursor menjadi tangan untuk elemen yang bisa diklik */
        a, button, [data-page], [onclick], .menu-item, .cursor-pointer {
            cursor: pointer;
        }
         /* Style untuk menonaktifkan input radio */
        input[type="radio"]:disabled + span {
            color: #9ca3af; /* Gray-400 */
            cursor: not-allowed;
        }
         input[type="radio"]:disabled {
            background-color: #e5e7eb; /* Gray-200 */
            border-color: #d1d5db; /* Gray-300 */
            cursor: not-allowed;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: all 0.2s;
            gap: 0.5rem;
        }
        .btn-primary {
            background-color: #2563eb;
            color: white;
        }
        .btn-primary:hover {
            background-color: #1d4ed8;
        }
        .btn-secondary {
            background-color: #64748b;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #475569;
        }
        .btn-success {
            background-color: #16a34a;
            color: white;
        }
        .btn-success:hover {
            background-color: #15803d;
        }
        .btn-danger {
            background-color: #dc2626;
            color: white;
        }
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        .menu-item {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
            font-weight: 500;
        }
        .menu-item:hover {
            background-color: #eff6ff; /* blue-50 */
            color: #1d4ed8; /* blue-700 */
        }
        .menu-item.active {
            background-color: #1d4ed8;
            color: white;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-50 p-4">
        <div class="w-full max-w-md">
            <div class="bg-white p-8 rounded-2xl shadow-lg text-center">
                <div class="flex justify-center mb-6">
                     <div id="login-logo-container" class="relative cursor-pointer group w-20 h-20">
                        <div id="login-logo-placeholder" class="w-20 h-20 bg-blue-200 rounded-full flex items-center justify-center">
                            <span id="login-logo-initials-text" class="text-3xl font-bold text-blue-600">SD</span>
                        </div>
                        <img id="login-school-logo" src="#" alt="Logo Sekolah" class="w-20 h-20 rounded-full object-cover hidden">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 flex items-center justify-center rounded-full transition-opacity duration-300">
                            <i data-lucide="camera" class="w-8 h-8 text-white opacity-0 group-hover:opacity-100"></i>
                        </div>
                    </div>
                    <input type="file" id="login-logo-input" class="hidden" accept="image/*">
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">SMP DIPONEGORO SAMPANG</h1>
                <p class="text-gray-500 mb-6">Silakan login untuk melanjutkan</p>

                <div id="login-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 hidden" role="alert">
                    <strong class="font-bold">Gagal!</strong>
                    <span class="block sm:inline">Nama Guru dan Jabatan tidak sesuai.</span>
                </div>

                <div class="space-y-4">
                    <div>
                        <input type="text" id="id-guru-login" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan No. ID">
                    </div>
                    <div>
                        <select id="nama-guru-login" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Pilih Nama Guru</option>
                        </select>
                    </div>
                    <div>
                        <select id="jabatan-login" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                             <option value="">Pilih Jabatan</option>
                        </select>
                    </div>
                </div>
                <button id="login-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-300 mt-6 font-bold">Login</button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="hidden min-h-screen">
        <!-- Header -->
        <header id="app-header" class="bg-blue-600 shadow-md sticky top-0 z-20">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <!-- Logo and School Name -->
                    <div class="flex items-center space-x-4">
                         <div id="logo-container" class="relative cursor-pointer group">
                            <div id="logo-placeholder" class="w-10 h-10 bg-blue-200 rounded-full flex items-center justify-center text-lg font-bold text-blue-600">
                                <!-- Inisial akan diisi oleh JS -->
                           </div>
                           <img id="school-logo" src="#" alt="Logo Sekolah" class="w-10 h-10 rounded-full object-cover hidden">
                           <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 flex items-center justify-center rounded-full transition-opacity duration-300">
                               <i data-lucide="camera" class="w-5 h-5 text-white opacity-0 group-hover:opacity-100"></i>
                           </div>
                        </div>
                        <input type="file" id="logo-input" class="hidden" accept="image/*">
                        <span class="text-xl font-bold text-white">SMP Diponegoro Sampang</span>
                    </div>

                    <!-- Realtime Clock -->
                    <div id="realtime-clock" class="hidden md:flex flex-col items-center text-white">
                        <span id="clock-time" class="text-xl font-bold tracking-wider"></span>
                        <span id="clock-date" class="text-xs"></span>
                    </div>

                    <!-- Profile, Logout, and Mobile Menu Button -->
                    <div class="flex items-center space-x-2">
                        <div id="profile-image-container" class="relative cursor-pointer group">
                             <div id="profile-placeholder" class="w-10 h-10 bg-blue-200 rounded-full flex items-center justify-center border-2 border-blue-200 text-sm font-semibold text-blue-600">
                                <!-- Inisial profil akan diisi oleh JS -->
                             </div>
                             <img id="profile-img" src="#" alt="Foto Profil" class="w-10 h-10 rounded-full border-2 border-blue-200 object-cover hidden">
                             <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 flex items-center justify-center rounded-full transition-opacity duration-300">
                                <i data-lucide="camera" class="w-5 h-5 text-white opacity-0 group-hover:opacity-100"></i>
                             </div>
                        </div>
                        <input type="file" id="profile-input" class="hidden" accept="image/*">
                        <div class="text-left hidden sm:block">
                            <p id="profile-name" class="font-semibold text-sm text-white">Nama Guru</p>
                            <p id="profile-role" class="text-xs text-blue-200">Jabatan</p>
                        </div>
                        <button id="logout-btn" class="p-2 rounded-full text-white hover:bg-red-500 transition-colors cursor-pointer">
                            <i data-lucide="log-out" class="w-5 h-5"></i>
                        </button>
                         <!-- Mobile Menu Button -->
                        <div id="mobile-menu-container" class="md:hidden">
                            <button id="mobile-menu-btn" class="p-2 rounded-md text-white hover:bg-blue-700 cursor-pointer">
                                <i data-lucide="menu" class="w-6 h-6"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Bar -->
        <nav id="app-nav" class="bg-white shadow-md sticky top-16 z-10">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Desktop Menu -->
                <div class="hidden md:flex justify-start items-center h-12">
                    <a data-page="beranda" id="menu-beranda" class="menu-item active">Beranda</a>
                    <div id="menu-data-guru-container" class="contents">
                        <span class="text-gray-300 mx-2">|</span>
                        <a data-page="guru" id="menu-guru" class="menu-item">Data Guru</a>
                    </div>
                    <div id="menu-data-siswa-container" class="contents">
                        <span class="text-gray-300 mx-2">|</span>
                        <a data-page="data-siswa" id="menu-data-siswa" class="menu-item">Data Siswa</a>
                    </div>
                    
                    <!-- Menu Absensi Dinamis berdasarkan Peran (START) -->
                    <!-- Container for Guru Piket -->
                    <div id="absensi-piket-menu" class="contents">
                        <span class="text-gray-300 mx-2">|</span>
                        <a data-page="absensi" class="menu-item">Absensi Siswa</a>
                    </div>
                    <!-- Container for KS/WKS -->
                    <div id="absensi-ks-menu" class="contents">
                        <span class="text-gray-300 mx-2">|</span>
                        <a data-page="absensi-guru" class="menu-item">Absensi Guru</a>
                    </div>
                    <!-- Container for Admin -->
                    <div id="absensi-admin-menu" class="contents">
                         <span class="text-gray-300 mx-2">|</span>
                         <div class="relative">
                            <button id="absensi-dropdown-btn" class="menu-item flex items-center space-x-1">
                                <span>Absensi</span>
                                <i data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                            </button>
                            <div id="absensi-dropdown-menu" class="absolute top-full mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20 hidden ring-1 ring-black ring-opacity-5">
                                <a data-page="absensi" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 menu-item">Absensi Siswa</a>
                                <a data-page="absensi-guru" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 menu-item">Absensi Guru</a>
                            </div>
                        </div>
                    </div>
                    <!-- Menu Absensi Dinamis berdasarkan Peran (END) -->

                    <span class="text-gray-300 mx-2">|</span>
                    <a data-page="laporan" id="menu-laporan" class="menu-item">Laporan</a>
                </div>
                 <!-- Mobile Menu -->
                <div id="mobile-menu" class="hidden md:hidden py-2">
                    <a data-page="beranda" class="block menu-item active text-center">Beranda</a>
                    <a data-page="guru" id="mobile-menu-guru" class="block menu-item">Data Guru</a>
                    <a data-page="data-siswa" id="mobile-menu-data-siswa" class="block menu-item text-center">Data Siswa</a>
                    <a data-page="absensi" class="block menu-item text-center">Absensi Siswa</a>
                    <a data-page="absensi-guru" class="block menu-item text-center">Absensi Guru</a>
                    <a data-page="laporan" class="block menu-item text-center">Laporan</a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main id="content" class="container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Beranda Page -->
            <div id="beranda-page" class="page">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Selamat Datang!</h1>
                <p class="text-base text-gray-600 mb-8">Sistem Informasi Absensi Siswa SMP Diponegoro Sampang.</p>

                <!-- Holiday Settings for Admin -->
                <div id="holiday-settings-container" class="bg-white p-6 rounded-xl shadow-md mb-8 hidden">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Pengaturan Hari Libur Bulan Ini</h2>
                    <p class="text-sm text-gray-500 mb-4">Pilih tanggal untuk ditetapkan sebagai hari libur. Semua absensi pada tanggal tersebut akan otomatis ditandai sebagai libur ("-").</p>
                    <div class="overflow-x-auto">
                        <table id="holiday-calendar-table" class="w-full border-collapse text-center">
                            <!-- Kalender akan digenerate oleh JavaScript -->
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <div class="flex items-center space-x-4">
                            <div class="p-3 bg-blue-100 rounded-full">
                                <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <div>
                                <p class="text-gray-500">Total Siswa</p>
                                <p id="total-siswa" class="text-2xl font-bold text-gray-800">0</p>
                            </div>
                        </div>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-md">
                        <div class="flex items-center space-x-4">
                            <div class="p-3 bg-green-100 rounded-full">
                                <i data-lucide="user-check" class="w-6 h-6 text-green-600"></i>
                            </div>
                            <div>
                                <p class="text-gray-500">Hadir Hari Ini</p>
                                <p id="total-hadir" class="text-2xl font-bold text-gray-800">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <div class="flex items-center space-x-4">
                            <div class="p-3 bg-yellow-100 rounded-full">
                                <i data-lucide="user-minus" class="w-6 h-6 text-yellow-600"></i>
                            </div>
                            <div>
                                <p class="text-gray-500">Izin Hari Ini</p>
                                <p id="total-izin" class="text-2xl font-bold text-gray-800">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <div class="flex items-center space-x-4">
                            <div class="p-3 bg-orange-100 rounded-full">
                                <i data-lucide="thermometer" class="w-6 h-6 text-orange-600"></i>
                            </div>
                            <div>
                                <p class="text-gray-500">Sakit Hari Ini</p>
                                <p id="total-sakit" class="text-2xl font-bold text-gray-800">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <div class="flex items-center space-x-4">
                            <div class="p-3 bg-red-100 rounded-full">
                                <i data-lucide="user-x" class="w-6 h-6 text-red-600"></i>
                            </div>
                            <div>
                                <p class="text-gray-500">Alpha Hari Ini</p>
                                <p id="total-alpha" class="text-2xl font-bold text-gray-800">0</p>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="mt-8">
                    <h2 id="summary-title-daily" class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Ringkasan Kehadiran Hari Ini per Kelas</h2>
                    <div id="per-class-charts-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        <!-- Diagram per kelas akan dimuat di sini oleh JavaScript -->
                    </div>
                </div>
                <div class="mt-12">
                    <h2 id="summary-title-monthly" class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Ringkasan Kehadiran Bulan Ini per Kelas</h2>
                     <div id="monthly-per-class-charts-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        <!-- Diagram bulanan per kelas akan dimuat di sini oleh JavaScript -->
                    </div>
                </div>
                 <div class="mt-12">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Grafik Kehadiran Siswa</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 id="chart-title-student-daily" class="text-lg font-semibold text-gray-800 mb-4 text-center">Hari Ini</h3>
                            <div id="overall-daily-pie-chart" style="width: 100%; height: 300px;"></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 id="chart-title-student-monthly" class="text-lg font-semibold text-gray-800 mb-4 text-center">Bulan Ini</h3>
                            <div id="overall-monthly-pie-chart" style="width: 100%; height: 300px;"></div>
                        </div>
                    </div>
                </div>
                <div id="grafik-guru-container" class="mt-12">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Grafik Kehadiran Guru</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 id="chart-title-teacher-daily" class="text-lg font-semibold text-gray-800 mb-4 text-center">Hari Ini</h3>
                            <div id="overall-daily-teacher-pie-chart" style="width: 100%; height: 300px;"></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 id="chart-title-teacher-monthly" class="text-lg font-semibold text-gray-800 mb-4 text-center">Bulan Ini</h3>
                            <div id="overall-monthly-teacher-pie-chart" style="width: 100%; height: 300px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Guru Page -->
            <div id="guru-page" class="page hidden">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Data Guru</h1>
                    <div class="flex items-center space-x-2">
                         <button id="simpan-perubahan-guru" class="btn btn-primary hidden">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            <span>Simpan Perubahan</span>
                        </button>
                        <button id="tambah-guru-manual" class="btn btn-success">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            <span>Tambah Guru</span>
                        </button>
                        <button id="upload-guru-excel" class="btn btn-secondary">
                            <i data-lucide="upload" class="w-4 h-4"></i>
                            <span>Upload Excel</span>
                        </button>
                        <input type="file" id="guru-file-input" class="hidden" accept=".xlsx, .xls">
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-green-600 text-white">
                                <tr>
                                    <th class="p-3 font-semibold">No</th>
                                    <th class="p-3 font-semibold">Nama Guru</th>
                                    <th class="p-3 font-semibold">Jabatan</th>
                                    <th class="p-3 font-semibold text-center aksi-kolom">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tabel-guru">
                                <!-- Data guru akan dimuat di sini oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Data Siswa Page -->
            <div id="data-siswa-page" class="page hidden">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Data Siswa</h1>
                    <div class="flex items-center space-x-2">
                        <button id="simpan-perubahan-siswa" class="btn btn-primary hidden">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            <span>Simpan Perubahan</span>
                        </button>
                        <div id="bulk-action-container" class="hidden items-center space-x-2">
                            <button id="hapus-terpilih-btn" class="btn btn-danger">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                <span>Hapus Terpilih</span>
                            </button>
                        </div>
                        <button id="tambah-siswa-manual" class="btn btn-success">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            <span>Tambah Siswa</span>
                        </button>
                        <button id="upload-siswa-excel" class="btn btn-secondary">
                            <i data-lucide="upload" class="w-4 h-4"></i>
                            <span>Upload Excel</span>
                        </button>
                        <input type="file" id="siswa-file-input" class="hidden" accept=".xlsx, .xls">
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex items-center justify-end mb-4">
                        <label for="filter-kelas-data-siswa" class="text-sm font-medium mr-2">Filter Kelas:</label>
                        <select id="filter-kelas-data-siswa" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="all">Semua Kelas</option>
                                <!-- Opsi kelas akan dimuat di sini -->
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-green-600 text-white">
                                <tr>
                                    <th class="p-3 text-center aksi-kolom-admin">
                                        <input type="checkbox" id="select-all-siswa" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    </th>
                                    <th class="p-3 font-semibold">NIS</th>
                                    <th class="p-3 font-semibold">NISN</th>
                                    <th class="p-3 font-semibold">Nama Siswa</th>
                                    <th class="p-3 font-semibold">Kelas</th>
                                    <th class="p-3 font-semibold text-center aksi-kolom">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tabel-data-siswa">
                                <!-- Data siswa akan dimuat di sini -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Absensi Siswa Page -->
            <div id="absensi-page" class="page hidden">
                 <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Absensi Siswa</h1>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex items-center justify-end mb-4">
                        <label for="filter-kelas" class="text-sm font-medium mr-2">Filter Kelas:</label>
                        <select id="filter-kelas" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                             <option value="all">Semua Kelas</option>
                             <!-- Opsi kelas akan dimuat di sini -->
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-green-600 text-white">
                                <tr>
                                    <th class="p-3 font-semibold">NIS</th>
                                    <th class="p-3 font-semibold">NISN</th>
                                    <th class="p-3 font-semibold">Nama Siswa</th>
                                    <th class="p-3 font-semibold">Kelas</th>
                                    <th class="p-3 font-semibold">Status Kehadiran</th>
                                </tr>
                            </thead>
                            <tbody id="tabel-absensi-siswa">
                                <!-- Data absensi siswa akan dimuat di sini -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Absensi Guru Page -->
            <div id="absensi-guru-page" class="page hidden">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Absensi Guru</h1>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-green-600 text-white">
                                <tr>
                                    <th class="p-3 font-semibold">No</th>
                                    <th class="p-3 font-semibold">Nama Guru</th>
                                    <th class="p-3 font-semibold">Jabatan</th>
                                    <th class="p-3 font-semibold">Status Kehadiran</th>
                                </tr>
                            </thead>
                            <tbody id="tabel-absensi-guru">
                                <!-- Data absensi guru akan dimuat di sini -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Laporan Page -->
            <div id="laporan-page" class="page hidden">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Laporan Absensi</h1>
                </div>

                <!-- Tab navigation -->
                <div id="laporan-nav-container" class="mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                             <button id="laporan-siswa-tab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600">
                                Laporan Absensi Siswa
                            </button>
                             <button id="laporan-guru-tab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                Laporan Absensi Guru
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- Student Report Content -->
                <div id="laporan-siswa-content">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                         <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                             <div>
                                <h2 id="report-title-student-daily" class="text-xl font-semibold text-gray-800">Rekapitulasi Ketidakhadiran Siswa Hari Ini</h2>
                                <p class="text-sm text-gray-500 mt-1">Laporan ini menampilkan daftar siswa yang tidak hadir (Sakit, Izin, Alpha) pada hari ini.</p>
                             </div>
                             <button id="download-siswa-pdf" class="btn btn-primary">
                                <i data-lucide="download" class="w-4 h-4"></i>
                                <span>Download PDF Bulanan</span>
                            </button>
                         </div>
                         <div class="flex items-center justify-end mb-4">
                            <label for="filter-kelas-laporan" class="text-sm font-medium mr-2">Filter Kelas:</label>
                            <select id="filter-kelas-laporan" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                 <option value="all">Semua Kelas</option>
                                 <!-- Opsi kelas akan dimuat di sini -->
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-green-600 text-white">
                                    <tr>
                                        <th class="p-3 font-semibold">Nama Siswa</th>
                                        <th class="p-3 font-semibold">Kelas</th>
                                        <th class="p-3 font-semibold">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="tabel-laporan-harian-siswa">
                                    <!-- Data laporan harian akan dimuat di sini -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Guru Report Content -->
                <div id="laporan-guru-content" class="hidden">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                         <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                             <div>
                                <h2 id="report-title-teacher-daily" class="text-xl font-semibold text-gray-800">Rekapitulasi Ketidakhadiran Guru Hari Ini</h2>
                                 <p class="text-sm text-gray-500 mt-1">Laporan ini menampilkan daftar guru yang tidak hadir (Sakit, Izin, Alpha) pada hari ini.</p>
                             </div>
                             <button id="download-guru-pdf" class="btn btn-primary">
                                <i data-lucide="download" class="w-4 h-4"></i>
                                <span>Download PDF Bulanan</span>
                            </button>
                         </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-green-600 text-white">
                                    <tr>
                                        <th class="p-3 font-semibold">Nama Guru</th>
                                        <th class="p-3 font-semibold">Jabatan</th>
                                        <th class="p-3 font-semibold">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="tabel-laporan-harian-guru">
                                    <!-- Data laporan harian guru akan dimuat di sini -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tambah/Edit Guru Page -->
            <div id="tambah-guru-page" class="page hidden">
                <h1 id="tambah-guru-page-title" class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Tambah Guru Baru</h1>
                <div class="bg-white p-8 rounded-xl shadow-md max-w-2xl mx-auto">
                    <form id="guru-form">
                        <input type="hidden" id="guru-id">
                        <div class="space-y-4">
                            <div>
                                <label for="guru-nama" class="block text-sm font-medium text-gray-700 mb-1">Nama Guru</label>
                                <input type="text" id="guru-nama" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label for="guru-jabatan" class="block text-sm font-medium text-gray-700 mb-1">Jabatan</label>
                                <input type="text" id="guru-jabatan" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-2 mt-8">
                            <button type="button" id="batal-guru" class="btn btn-secondary px-6">Batal</button>
                            <button type="submit" id="simpan-guru-btn" class="btn btn-primary px-6">Simpan</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tambah/Edit Siswa Page -->
            <div id="tambah-siswa-page" class="page hidden">
                 <h1 id="tambah-siswa-page-title" class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Tambah Siswa Baru</h1>
                 <div class="bg-white p-8 rounded-xl shadow-md max-w-2xl mx-auto">
                    <form id="siswa-form">
                        <input type="hidden" id="siswa-nis-edit">
                        <div class="space-y-4">
                             <div>
                                <label for="siswa-nis" class="block text-sm font-medium text-gray-700 mb-1">NIS</label>
                                <input type="text" id="siswa-nis" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                             <div>
                                <label for="siswa-nisn" class="block text-sm font-medium text-gray-700 mb-1">NISN</label>
                                <input type="text" id="siswa-nisn" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label for="siswa-nama" class="block text-sm font-medium text-gray-700 mb-1">Nama Siswa</label>
                                <input type="text" id="siswa-nama" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label for="siswa-kelas" class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                                <input type="text" id="siswa-kelas" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-2 mt-8">
                            <button type="button" id="batal-siswa" class="btn btn-secondary px-6">Batal</button>
                            <button type="submit" class="btn btn-primary px-6">Simpan</button>
                        </div>
                    </form>
                 </div>
            </div>
        </main>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 hidden opacity-0">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm mx-auto shadow-xl transform transition-all duration-300 scale-95 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="confirm-title">Hapus Data</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500" id="confirm-message">Apakah Anda yakin ingin menghapus data ini? Tindakan ini tidak dapat dibatalkan.</p>
            </div>
            <div class="items-center px-4 py-3 flex justify-center space-x-2">
                <button id="confirm-cancel" class="btn btn-secondary px-6">Batal</button>
                <button id="confirm-delete" class="btn btn-danger px-6">Hapus</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Load Google Charts
            google.charts.load('current', { 'packages': ['corechart'] });
            google.charts.setOnLoadCallback(setChartsLoaded);

            let isGoogleChartsLoaded = false;
            
            // --- Google Apps Script URL ---
            // PENTING: Ganti dengan URL hasil deployment Google Apps Script Anda
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxgelHi8R9wOkXok_TiOHhENP0Q9j23U6_TTe3CQygEKM0rzBR316x_9dYlkeCO3J5_pA/exec'; // <-- PASTE URL ANDA DI SINI

            // --- DATA LOKAL (sebagai cache) ---
            let dataGuru = [];
            let dataSiswa = [];
            let rekapSiswa = [];
            let rekapGuru = [];
            let guruPendingChanges = [];
            let siswaPendingChanges = [];
            let manualHolidays = new Set(); // Set untuk menyimpan hari libur yang diatur manual

            // --- ELEMEN DOM ---
            const loginScreen = document.getElementById('login-screen');
            const appScreen = document.getElementById('app');
            const filterKelas = document.getElementById('filter-kelas');
            const confirmModal = document.getElementById('confirm-modal');
            const appNav = document.getElementById('app-nav');
            const mobileMenuContainer = document.getElementById('mobile-menu-container');
            
            let deleteCallback = null;
            let currentUserRole = null; // Menyimpan jabatan pengguna yang login

            // --- FUNGSI-FUNGSI ---

            // Fungsi untuk menginisialisasi hari libur manual dari data rekap
            function initializeManualHolidays() {
                manualHolidays.clear();
                if (!rekapSiswa || rekapSiswa.length < 2) return;

                const headers = rekapSiswa[0];
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth() + 1;

                for (let day = 1; day <= 31; day++) {
                    const dateColumnIndex = headers.indexOf(day) > -1 ? headers.indexOf(day) : headers.indexOf(String(day));
                    if (dateColumnIndex > -1) {
                        // Cek jika semua status di hari itu adalah '-'
                        const isDayOffForAll = rekapSiswa.slice(1).every(row => row[dateColumnIndex] === '-');
                        if (isDayOffForAll) {
                            manualHolidays.add(`${year}-${month}-${day}`);
                        }
                    }
                }
            }


            // Fungsi untuk mengecek hari libur (Sabtu, Minggu, Libur Nasional, dan Manual)
            function isHoliday(date) {
                const year = date.getFullYear();
                const month = date.getMonth() + 1; // getMonth() is 0-indexed
                const day = date.getDate();
                const dayOfWeek = date.getDay();

                // Cek akhir pekan
                if (dayOfWeek === 0 || dayOfWeek === 6) return true;

                // Cek libur nasional
                const nationalHolidays = [
                    '2025-1-1', '2025-1-27', '2025-1-29', '2025-3-29', '2025-3-31', 
                    '2025-4-1', '2025-4-18', '2025-5-1', '2025-5-12', '2025-5-29', 
                    '2025-6-1', '2025-6-7', '2025-6-27', '2025-8-17', '2025-9-5', '2025-12-25'
                ];
                const dateStringYMD = `${year}-${month}-${day}`;
                if (nationalHolidays.includes(dateStringYMD)) return true;
                
                // Cek libur manual
                if (manualHolidays.has(dateStringYMD)) return true;

                return false;
            }
            
            // Fungsi untuk mendapatkan tanggal hari ini dalam format yang bagus
            function getTodayFormattedDate() {
                return new Date().toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });
            }

            // Fungsi untuk mendapatkan bulan dan tahun saat ini
            function getCurrentMonthYear() {
                return new Date().toLocaleDateString('id-ID', {
                    month: 'long',
                    year: 'numeric'
                });
            }

            function isLastDayOfMonth(date = new Date()) {
                const tomorrow = new Date(date);
                tomorrow.setDate(date.getDate() + 1);
                return tomorrow.getDate() === 1;
            }

            // Fungsi untuk memperbarui semua tampilan tanggal
            function updateDateDisplays() {
                const todayDate = getTodayFormattedDate();

                // Beranda
                const summaryTitle = document.getElementById('summary-title-daily');
                if (summaryTitle) summaryTitle.textContent = `Ringkasan Kehadiran per Kelas - ${todayDate}`;
                
                const studentChartTitle = document.getElementById('chart-title-student-daily');
                if (studentChartTitle) studentChartTitle.textContent = todayDate;
                
                const teacherChartTitle = document.getElementById('chart-title-teacher-daily');
                if (teacherChartTitle) teacherChartTitle.textContent = todayDate;

                // Laporan
                const studentReportTitle = document.getElementById('report-title-student-daily');
                if (studentReportTitle) studentReportTitle.textContent = `Rekapitulasi Ketidakhadiran Siswa - ${todayDate}`;
                
                const teacherReportTitle = document.getElementById('report-title-teacher-daily');
                if (teacherReportTitle) teacherReportTitle.textContent = `Rekapitulasi Ketidakhadiran Guru - ${todayDate}`;
            }

            // Fungsi untuk memperbarui semua tampilan bulan-tahun
            function updateMonthYearDisplays() {
                const monthYear = getCurrentMonthYear();

                const summaryTitle = document.getElementById('summary-title-monthly');
                if (summaryTitle) summaryTitle.textContent = `Ringkasan Kehadiran per Kelas - ${monthYear}`;

                const studentChartTitle = document.getElementById('chart-title-student-monthly');
                if (studentChartTitle) studentChartTitle.textContent = monthYear;

                const teacherChartTitle = document.getElementById('chart-title-teacher-monthly');
                if (teacherChartTitle) teacherChartTitle.textContent = monthYear;
            }

            // Fungsi untuk menampilkan jam dan tanggal realtime
            function updateClock() {
                const now = new Date();
                const timeEl = document.getElementById('clock-time');
                const dateEl = document.getElementById('clock-date');

                if (timeEl && dateEl) {
                    const timeString = now.toLocaleTimeString('id-ID', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    }).replace(/\./g, ':');
                    timeEl.textContent = timeString;

                    const dateString = now.toLocaleDateString('id-ID', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    dateEl.textContent = dateString;
                }
            }

            // Update jam setiap detik
            setInterval(updateClock, 1000);
            
            // Fungsi untuk menampilkan overlay loading
            function showLoading(message = 'Memuat...') {
                const loadingOverlay = document.createElement('div');
                loadingOverlay.id = 'loading-overlay';
                loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                loadingOverlay.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl flex items-center space-x-4">
                        <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="font-medium">${message}</span>
                    </div>
                `;
                document.body.appendChild(loadingOverlay);
            }

            // Fungsi untuk menyembunyikan overlay loading
            function hideLoading() {
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.remove();
                }
            }
            
            // Fungsi untuk mengirim data ke Google Apps Script
            async function postData(payload, showLoader = true) {
                 if (!SCRIPT_URL) {
                    alert("Aksi tidak dapat dilanjutkan karena URL Google Apps Script belum diatur. Silakan perbarui file HTML Anda.");
                    return false;
                }
                if (showLoader) showLoading('Menyimpan data...');
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'cors',
                        redirect: 'follow',
                        cache: 'no-cache',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8', // Diperlukan untuk Apps Script
                        },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (result.status !== 'success') {
                        throw new Error(result.message);
                    }
                    console.log('Server response:', result.message);
                    return true;
                } catch (error) {
                    console.error('Error posting data:', error);
                    // Selalu tampilkan notifikasi jika gagal, bahkan untuk proses latar belakang
                    alert('Gagal menyimpan data ke server: ' + error.message);
                    return false;
                } finally {
                    if (showLoader) hideLoading();
                }
            }


            function setChartsLoaded() {
                isGoogleChartsLoaded = true;
                const visiblePage = document.querySelector('.page:not(.hidden)');
                if (visiblePage) {
                    const pageId = visiblePage.id.replace('-page', '');
                    renderChartsForPage(pageId);
                }
            }
            
            // --- Fungsi Auto-Refresh dan Inisialisasi ---
            async function fetchDataAndUpdate(isInitialLoad = false) {
                if (isInitialLoad) {
                    showLoading('Mengambil data awal...');
                }

                if (!SCRIPT_URL) {
                    if (isInitialLoad) {
                        alert("PENTING: URL Google Apps Script belum diatur. Silakan ikuti file instructions.md dan paste URL Anda di dalam file HTML ini.");
                        generateDummyData();
                        refreshUI();
                        hideLoading();
                    }
                    return;
                }

                try {
                    const response = await fetch(SCRIPT_URL, { redirect: 'follow', cache: 'no-cache' });
                    const data = await response.json();
                    
                    if (data.status === 'error') {
                        throw new Error(data.message);
                    }

                    const hasDataChanged = JSON.stringify(dataSiswa) !== JSON.stringify(data.siswa) ||
                                           JSON.stringify(dataGuru) !== JSON.stringify(data.guru) ||
                                           JSON.stringify(rekapSiswa) !== JSON.stringify(data.rekapSiswa) ||
                                           JSON.stringify(rekapGuru) !== JSON.stringify(data.rekapGuru);

                    if (hasDataChanged || isInitialLoad) {
                        dataGuru = data.guru;
                        dataSiswa = data.siswa;
                        rekapSiswa = data.rekapSiswa || [];
                        rekapGuru = data.rekapGuru || [];

                        if (isInitialLoad) {
                            console.log("Data awal berhasil dimuat.");
                            initializeManualHolidays(); // Inisialisasi hari libur dari data
                            refreshUI(); 
                        } else {
                            console.log("Data terdeteksi berubah, melakukan refresh otomatis...");
                            const visiblePageId = document.querySelector('.page:not(.hidden)')?.id;
                            
                            if (visiblePageId === 'beranda-page') {
                                updateDashboardCards();
                                renderChartsForPage('beranda');
                            } else if (visiblePageId === 'absensi-page') {
                                muatAbsensiSiswa(document.getElementById('filter-kelas').value);
                            } else if (visiblePageId === 'absensi-guru-page') {
                                muatAbsensiGuru();
                            }
                        }
                    }
                } catch (error) {
                    console.error("Gagal mengambil data untuk refresh:", error);
                    if (isInitialLoad) {
                        alert("Gagal mengambil data dari Google Sheets. Menggunakan data dummy. Error: " + error.message);
                        generateDummyData();
                        refreshUI();
                    }
                } finally {
                    if (isInitialLoad) {
                        hideLoading();
                    }
                }
            }

            async function init() {
                updateClock();
                updatePlaceholders();
                
                await fetchDataAndUpdate(true);
                
                loadSavedImages();
                setupEventListeners();
                lucide.createIcons();

                setInterval(() => fetchDataAndUpdate(false), 30000); 
                console.log("Auto-refresh diaktifkan setiap 30 detik.");
            }

            function generateDummyData(){
                dataGuru = [
                    {id: 1, nama: 'Ahmad Mutasir', jabatan: 'Kepala Sekolah', status: 'Hadir'},
                    {id: 8, nama: 'Ina Solikhati', jabatan: 'Wakil Kepala Sekolah', status: 'Hadir'},
                    {id: 7, nama: 'Urip Ambaripto', jabatan: 'Administrator', status: 'Hadir'},
                    {id: 2, nama: 'Arief Kurniawan', jabatan: 'Guru Piket', status: 'Hadir'},
                    {id: 3, nama: 'Salsabila Nur Anisa', jabatan: 'Guru Piket', status: 'Hadir'},
                    {id: 4, nama: 'Heni Faridanti Auni', jabatan: 'Guru Piket', status: 'Sakit'},
                    {id: 5, nama: 'Isti Kharirotun Nangimah', jabatan: 'Guru Piket', status: 'Hadir'},
                    {id: 6, nama: 'Mukhammad Mukhamim', jabatan: 'Guru Piket', status: 'Hadir'},
                ];

                dataSiswa = [
                    {nis: '1001', nisn: '001', nama: 'Budi Santoso', kelas: 'VII A', status: 'Hadir'},
                    {nis: '1002', nisn: '002', nama: 'Adi Wijaya', kelas: 'VII A', status: 'Sakit'},
                    {nis: '1003', nisn: '003', nama: 'Sita Lestari', kelas: 'VII B', status: 'Izin'},
                    {nis: '1004', nisn: '004', nama: 'Dewi Wati', kelas: 'VII B', status: 'Alpha'},
                    {nis: '1005', nisn: '005', nama: 'Joko Susanto', kelas: 'IX A', status: 'Hadir'},
                ];
                rekapSiswa = [
                    ['NIS', 'Nama', 'Kelas', 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 'Jumlah H', 'Jumlah S', 'Jumlah I', 'Jumlah A'],
                    ['1001', 'Budi Santoso', 'VII A', 'H','H','H','H','H','-','-','H','H','H','H','H','-','-','H','S','H','H','H','-','-','H','H','H','H','H','-','-','H', 22, 1, 0, 0],
                    ['1002', 'Adi Wijaya', 'VII A', 'H','H','S','H','H','-','-','H','H','H','H','H','-','-','H','H','H','H','H','-','-','H','H','I','H','H','-','-','H', 21, 1, 1, 0]
                ];
                rekapGuru = [
                    ['ID', 'Nama', 'Jabatan', 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 'Jumlah H', 'Jumlah S', 'Jumlah I', 'Jumlah A'],
                    [1, 'Ahmad Mutasir', 'Kepala Sekolah', 'H','H','H','H','H','-','-','H','H','H','H','H','-','-','H','H','H','H','H','-','-','H','I','H','H','H','-','-','H', 22, 0, 1, 0]
                ];
            }
            
            function refreshUI() {
                populateLoginDropdowns();
                muatDataGuru();
                muatDataSiswaTabel();
                muatAbsensiSiswa();
                muatAbsensiGuru();
                populateFilterKelas();
                populateLaporanFilterKelas(); 
                populateFilterKelasDataSiswa();
                updateDateDisplays(); // Memperbarui tanggal
                updateMonthYearDisplays(); // Memperbarui bulan-tahun
                updateDashboardCards();
                updateUIForRole(); // Pastikan UI peran diperbarui setelah semua data siap
            }
            
            // Load saved images from localStorage
            function loadSavedImages() {
                const schoolLogo = document.getElementById('school-logo');
                const logoPlaceholder = document.getElementById('logo-placeholder');
                const savedLogo = localStorage.getItem('schoolLogo');

                const loginSchoolLogo = document.getElementById('login-school-logo');
                const loginLogoPlaceholder = document.getElementById('login-logo-placeholder');

                if (savedLogo) {
                    schoolLogo.src = savedLogo;
                    schoolLogo.classList.remove('hidden');
                    logoPlaceholder.classList.add('hidden');

                    loginSchoolLogo.src = savedLogo;
                    loginSchoolLogo.classList.remove('hidden');
                    loginLogoPlaceholder.classList.add('hidden');
                }
            }

            function updatePlaceholders(guru = null) {
                // School Logo Placeholder
                const schoolName = "SMP Diponegoro Sampang";
                let nameParts = schoolName.split(' ').filter(Boolean);
                let initials = (nameParts.length > 1) ? nameParts[0][0] + nameParts[1][0] : nameParts[0].substring(0, 2);
                document.getElementById('logo-placeholder').textContent = initials.toUpperCase();
                document.getElementById('login-logo-initials-text').textContent = initials.toUpperCase();
                
                // Profile Placeholder
                const profilePlaceholder = document.getElementById('profile-placeholder');
                if (guru) {
                     nameParts = guru.nama.split(' ').filter(Boolean);
                     initials = (nameParts.length > 1) ? nameParts[0][0] + nameParts[1][0] : nameParts[0].substring(0, 2);
                     profilePlaceholder.textContent = initials.toUpperCase();
                }
            }
            
            // Show/Hide Modals
            function showModal(modal) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('div').classList.remove('scale-95');
                }, 10);
            }

            function hideModal(modal) {
                modal.classList.add('opacity-0');
                modal.querySelector('div').classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }

            // Mengisi dropdown pada halaman login
            function populateLoginDropdowns() {
                const namaGuruLogin = document.getElementById('nama-guru-login');
                const jabatanLogin = document.getElementById('jabatan-login');
                namaGuruLogin.innerHTML = '<option value="">Pilih Nama Guru</option>';
                jabatanLogin.innerHTML = '<option value="">Pilih Jabatan</option>';

                const guruDiizinkan = dataGuru.filter(g => 
                    g.jabatan === 'Kepala Sekolah' || 
                    g.jabatan === 'Wakil Kepala Sekolah' ||
                    g.jabatan === 'Guru Piket' || 
                    g.jabatan === 'Administrator'
                );

                const uniqueJabatanDiizinkan = [...new Set(guruDiizinkan.map(g => g.jabatan))];

                guruDiizinkan.forEach(guru => {
                    namaGuruLogin.innerHTML += `<option value="${guru.id}">${guru.nama}</option>`;
                });
                
                uniqueJabatanDiizinkan.forEach(jabatan => {
                    jabatanLogin.innerHTML += `<option value="${jabatan}">${jabatan}</option>`;
                });
            }

            // Fungsi Login
            function handleLogin() {
                const idGuruLogin = document.getElementById('id-guru-login');
                const namaGuruLogin = document.getElementById('nama-guru-login');
                const jabatanLogin = document.getElementById('jabatan-login');
                const loginError = document.getElementById('login-error');
                
                const profileName = document.getElementById('profile-name');
                const profileRole = document.getElementById('profile-role');

                const enteredId = parseInt(idGuruLogin.value);
                const selectedGuruId = parseInt(namaGuruLogin.value);
                const selectedJabatan = jabatanLogin.value;
                const guru = dataGuru.find(g => g.id == enteredId && g.id == selectedGuruId && g.jabatan === selectedJabatan);

                if (guru) {
                    currentUserRole = guru.jabatan; 
                    loginScreen.classList.add('hidden');
                    appScreen.classList.remove('hidden');
                    loginError.classList.add('hidden');
                    
                    profileName.textContent = guru.nama;
                    profileRole.textContent = guru.jabatan;
                    
                    updatePlaceholders(guru); // Set initials for profile
                    loadSavedImages(); // Check for saved profile image after setting initials

                    const savedProfileImage = localStorage.getItem('profileImage');
                    document.getElementById('profile-img').classList.toggle('hidden', !savedProfileImage);
                    document.getElementById('profile-placeholder').classList.toggle('hidden', !!savedProfileImage);

                    updateUIForRole();
                    updateAdminUI();

                } else {
                    loginError.querySelector('span').textContent = 'No. ID, Nama Guru, atau Jabatan tidak sesuai.';
                    loginError.classList.remove('hidden');
                }
            }

            // Fungsi Logout
            function handleLogout() {
                appScreen.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                document.getElementById('id-guru-login').value = '';
                document.getElementById('nama-guru-login').value = '';
                document.getElementById('jabatan-login').value = '';
                currentUserRole = null; 
                updateAdminUI();
                updateUIForRole();
            }

            // Mengatur UI berdasarkan peran pengguna
            function updateUIForRole() {
                const isPiket = currentUserRole === 'Guru Piket';
                const isKS_WKS = currentUserRole === 'Kepala Sekolah' || currentUserRole === 'Wakil Kepala Sekolah';
                const isAdmin = currentUserRole === 'Administrator';
                const isLoggedIn = !!currentUserRole;
                const isTodayHoliday = isHoliday(new Date());

                appNav.classList.toggle('hidden', !isLoggedIn);
                mobileMenuContainer.classList.toggle('hidden', !isLoggedIn);
                
                const menuPiket = document.getElementById('absensi-piket-menu');
                const menuKS = document.getElementById('absensi-ks-menu');
                const menuAdmin = document.getElementById('absensi-admin-menu');

                [menuPiket, menuKS, menuAdmin].forEach(el => el.style.display = 'none');

                if (isTodayHoliday) {
                    // Jika hari ini libur, sembunyikan semua menu absensi
                    console.log("Hari ini libur, menu absensi disembunyikan.");
                } else {
                    // Tampilkan menu absensi yang sesuai jika bukan hari libur
                    if (isPiket) {
                        menuPiket.style.display = 'contents';
                    } else if (isKS_WKS) {
                        menuKS.style.display = 'contents';
                    } else if (isAdmin) {
                        menuAdmin.style.display = 'contents';
                    }
                }

                // Hide/show data management menus
                const menuDataGuru = document.getElementById('menu-data-guru-container');
                const menuDataSiswa = document.getElementById('menu-data-siswa-container');
                const mobileMenuGuru = document.getElementById('mobile-menu-guru');
                const mobileMenuDataSiswa = document.getElementById('mobile-menu-data-siswa');
                const mobileMenuAbsenSiswa = document.querySelector('#mobile-menu a[data-page="absensi"]');
                const mobileMenuAbsenGuru = document.querySelector('#mobile-menu a[data-page="absensi-guru"]');

                if(menuDataGuru) menuDataGuru.style.display = isAdmin ? 'contents' : 'none';
                if(menuDataSiswa) menuDataSiswa.style.display = isAdmin ? 'contents' : 'none';
                if(mobileMenuGuru) mobileMenuGuru.style.display = isAdmin ? 'block' : 'none';
                if(mobileMenuDataSiswa) mobileMenuDataSiswa.style.display = isAdmin ? 'block' : 'none';

                // Sembunyikan menu absensi mobile jika hari libur
                 if (mobileMenuAbsenSiswa) mobileMenuAbsenSiswa.style.display = isTodayHoliday ? 'none' : 'block';
                 if (mobileMenuAbsenGuru) mobileMenuAbsenGuru.style.display = (isTodayHoliday || isPiket) ? 'none' : 'block';

                const grafikGuruContainer = document.getElementById('grafik-guru-container');
                if (grafikGuruContainer) {
                    grafikGuruContainer.style.display = isPiket ? 'none' : '';
                }

                const laporanGuruTab = document.getElementById('laporan-guru-tab');
                if (laporanGuruTab) {
                    // Administrator, Kepala Sekolah, dan Wakil Kepala Sekolah dapat melihat laporan guru.
                    if (isPiket) {
                        laporanGuruTab.style.display = 'none';
                    } else {
                        laporanGuruTab.style.display = '';
                    }
                }

                // PDF Download Button Logic
                const downloadSiswaBtn = document.getElementById('download-siswa-pdf');
                const downloadGuruBtn = document.getElementById('download-guru-pdf');
                const isLastDay = isLastDayOfMonth();

                if (downloadSiswaBtn && downloadGuruBtn) {
                    if (isAdmin || isLastDay) {
                        downloadSiswaBtn.disabled = false;
                        downloadGuruBtn.disabled = false;
                        downloadSiswaBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        downloadGuruBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        downloadSiswaBtn.title = 'Unduh rekapitulasi absensi siswa bulan ini.';
                        downloadGuruBtn.title = 'Unduh rekapitulasi absensi guru bulan ini.';
                    } else {
                        downloadSiswaBtn.disabled = true;
                        downloadGuruBtn.disabled = true;
                        downloadSiswaBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        downloadGuruBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        downloadSiswaBtn.title = 'Tombol download PDF bulanan hanya aktif pada akhir bulan.';
                        downloadGuruBtn.title = 'Tombol download PDF bulanan hanya aktif pada akhir bulan.';
                    }
                }

                // Jika pengguna adalah Guru Piket dan tab guru sedang aktif, pindah ke tab siswa
                if (isPiket && !document.getElementById('laporan-guru-content').classList.contains('hidden')) {
                    document.getElementById('laporan-siswa-tab').click();
                }


                // Tentukan halaman default setelah login
                if (isLoggedIn) {
                    tampilHalaman('beranda');
                }
            }
            
            // Pindah halaman
            function tampilHalaman(pageId) {
                document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
                const pageEl = document.getElementById(`${pageId}-page`);
                if (pageEl) {
                   pageEl.classList.remove('hidden');
                }

                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('data-page') === pageId) {
                        item.classList.add('active');
                    }
                });

                if (isGoogleChartsLoaded) {
                    renderChartsForPage(pageId);
                }
            }
            
            function renderChartsForPage(pageId) {
                if (pageId === 'laporan') {
                    muatLaporanHarianSiswa();
                    muatLaporanHarianGuru();
                    // Reset to the first tab
                    const siswaTab = document.getElementById('laporan-siswa-tab');
                    if (siswaTab) {
                        siswaTab.click();
                    }
                } else if (pageId === 'beranda') {
                    updateDashboardCards();
                    renderPerClassCharts();
                    renderMonthlyPerClassCharts();
                    renderOverallDailyPieChart();
                    renderOverallMonthlyPieChart();
                    renderOverallDailyTeacherPieChart();
                    renderOverallMonthlyTeacherPieChart();
                } else if (pageId === 'absensi') {
                    muatAbsensiSiswa();
                } else if (pageId === 'absensi-guru') {
                    muatAbsensiGuru();
                }
            }
            
            // Memuat data guru ke tabel
            function muatDataGuru() {
                const tabelBody = document.getElementById('tabel-guru');
                tabelBody.innerHTML = '';
                dataGuru.forEach((guru, index) => {
                    const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-green-50';
                    tabelBody.innerHTML += `
                        <tr class="${rowClass} hover:bg-green-100">
                            <td class="p-3">${index + 1}</td>
                            <td class="p-3 font-medium text-gray-800">${guru.nama}</td>
                            <td class="p-3 text-gray-600">${guru.jabatan}</td>
                            <td class="p-3 text-center aksi-kolom">
                                <div class="flex justify-center items-center space-x-2">
                                    <button class="edit-guru p-2 text-blue-500 hover:bg-blue-100 rounded-full cursor-pointer" data-id="${guru.id}"><i data-lucide="edit" class="w-4 h-4 pointer-events-none"></i></button>
                                    <button class="hapus-guru p-2 text-red-500 hover:bg-red-100 rounded-full cursor-pointer" data-id="${guru.id}"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                 lucide.createIcons();
                 updateAdminUI();
            }

            // Memuat data siswa ke tabel manajemen data
            function muatDataSiswaTabel(kelas = 'all') {
                const tabelBody = document.getElementById('tabel-data-siswa');
                const selectAllCheckbox = document.getElementById('select-all-siswa');
                
                if (!tabelBody) {
                    console.error("Elemen dengan ID 'tabel-data-siswa' tidak ditemukan.");
                    return;
                }
                
                tabelBody.innerHTML = '';
                if(selectAllCheckbox) selectAllCheckbox.checked = false;

                const filteredSiswa = (kelas === 'all') ? dataSiswa : dataSiswa.filter(s => s.kelas === kelas);

                filteredSiswa.forEach((siswa, index) => {
                    const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-green-50';
                    tabelBody.innerHTML += `
                        <tr class="${rowClass} hover:bg-green-100">
                            <td class="p-3 text-center aksi-kolom-admin">
                                <input type="checkbox" class="siswa-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-nis="${siswa.nis}">
                            </td>
                            <td class="p-3">${siswa.nis}</td>
                            <td class="p-3">${siswa.nisn}</td>
                            <td class="p-3 font-medium text-gray-800">${siswa.nama}</td>
                            <td class="p-3 text-gray-600">${siswa.kelas}</td>
                             <td class="p-3 text-center aksi-kolom">
                                <div class="flex justify-center items-center space-x-2">
                                    <button class="edit-siswa p-2 text-blue-500 hover:bg-blue-100 rounded-full cursor-pointer" data-nis="${siswa.nis}"><i data-lucide="edit" class="w-4 h-4 pointer-events-none"></i></button>
                                    <button class="hapus-siswa p-2 text-red-500 hover:bg-red-100 rounded-full cursor-pointer" data-nis="${siswa.nis}"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                 lucide.createIcons();
                 updateAdminUI();
            }
            
            // Memuat data siswa untuk absensi
            async function muatAbsensiSiswa(kelas = 'all') {
                const tabelBody = document.getElementById('tabel-absensi-siswa');
                tabelBody.innerHTML = '';

                const today = new Date();
                const isTodayHoliday = isHoliday(today);

                if (isTodayHoliday) {
                    tabelBody.innerHTML = `<tr><td colspan="5" class="text-center p-6 bg-yellow-50 text-yellow-800 font-medium">Hari ini adalah hari libur. Absensi dinonaktifkan.</td></tr>`;
                    return;
                }
                
                const filteredSiswa = (kelas === 'all') ? dataSiswa : dataSiswa.filter(s => s.kelas === kelas);
                const currentDay = today.getDate();
                const headers = (rekapSiswa && rekapSiswa.length > 0) ? rekapSiswa[0] : [];
                const dateColumnIndex = headers.indexOf(currentDay) > -1 ? headers.indexOf(currentDay) : headers.indexOf(String(currentDay));

                const rekapSiswaMap = new Map();
                if (rekapSiswa.length > 1) {
                    rekapSiswa.slice(1).forEach(row => rekapSiswaMap.set(String(row[0]), row));
                }

                filteredSiswa.forEach((siswa, index) => {
                    let currentStatus = 'Hadir';
                    if (dateColumnIndex !== -1 && rekapSiswaMap.has(String(siswa.nis))) {
                        currentStatus = rekapSiswaMap.get(String(siswa.nis))[dateColumnIndex] || 'Hadir';
                    } else {
                        currentStatus = siswa.status || 'Hadir';
                    }

                    const radioGroupName = `status-${siswa.nis}`;
                    const statuses = [
                        { value: 'Hadir', label: 'H' },
                        { value: 'Sakit', label: 'S' },
                        { value: 'Izin', label: 'I' },
                        { value: 'Alpha', label: 'A' }
                    ];
                    const radioButtons = statuses.map(statusInfo => `
                        <label class="inline-flex items-center mr-4" title="${statusInfo.value}">
                            <input type="radio" name="${radioGroupName}" value="${statusInfo.value}" data-nis="${siswa.nis}" class="attendance-radio form-radio h-4 w-4 text-blue-600" ${statusInfo.value.toUpperCase().startsWith(String(currentStatus).toUpperCase()) ? 'checked' : ''}>
                            <span class="ml-2 text-sm font-semibold w-4 text-center">${statusInfo.label}</span>
                        </label>
                    `).join('');

                    tabelBody.innerHTML += `
                        <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-green-50'}">
                            <td class="p-3">${siswa.nis}</td>
                            <td class="p-3">${siswa.nisn}</td>
                            <td class="p-3 font-medium text-gray-800">${siswa.nama}</td>
                            <td class="p-3 text-gray-600">${siswa.kelas}</td>
                            <td class="p-3"><div class="flex items-center">${radioButtons}</div></td>
                        </tr>
                    `;
                });
            }

            // Memuat data guru untuk absensi
            function muatAbsensiGuru() {
                const tabelBody = document.getElementById('tabel-absensi-guru');
                tabelBody.innerHTML = '';
                
                const today = new Date();
                const isTodayHoliday = isHoliday(today);

                if (isTodayHoliday) {
                    tabelBody.innerHTML = `<tr><td colspan="4" class="text-center p-6 bg-yellow-50 text-yellow-800 font-medium">Hari ini adalah hari libur. Absensi dinonaktifkan.</td></tr>`;
                    return;
                }
                
                const currentDay = today.getDate();
                const headers = (rekapGuru && rekapGuru.length > 0) ? rekapGuru[0] : [];
                const dateColumnIndex = headers.indexOf(currentDay) > -1 ? headers.indexOf(currentDay) : headers.indexOf(String(currentDay));

                const rekapGuruMap = new Map();
                if (rekapGuru.length > 1) {
                    rekapGuru.slice(1).forEach(row => rekapGuruMap.set(String(row[0]), row));
                }

                dataGuru.forEach((guru, index) => {
                    let currentStatus = 'Hadir';
                    if (dateColumnIndex !== -1 && rekapGuruMap.has(String(guru.id))) {
                        currentStatus = rekapGuruMap.get(String(guru.id))[dateColumnIndex] || 'Hadir';
                    } else {
                        currentStatus = guru.status || 'Hadir';
                    }

                    const radioGroupName = `status-guru-${guru.id}`;
                    const statuses = [
                        { value: 'Hadir', label: 'H' },
                        { value: 'Sakit', label: 'S' },
                        { value: 'Izin', label: 'I' },
                        { value: 'Alpha', label: 'A' }
                    ];
                    const radioButtons = statuses.map(statusInfo => `
                        <label class="inline-flex items-center mr-4" title="${statusInfo.value}">
                            <input type="radio" name="${radioGroupName}" value="${statusInfo.value}" data-id="${guru.id}" class="attendance-radio-guru form-radio h-4 w-4 text-blue-600" ${statusInfo.value.toUpperCase().startsWith(String(currentStatus).toUpperCase()) ? 'checked' : ''}>
                            <span class="ml-2 text-sm font-semibold w-4 text-center">${statusInfo.label}</span>
                        </label>
                    `).join('');

                    tabelBody.innerHTML += `
                        <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-green-50'}">
                            <td class="p-3">${index + 1}</td>
                            <td class="p-3 font-medium text-gray-800">${guru.nama}</td>
                            <td class="p-3 text-gray-600">${guru.jabatan}</td>
                            <td class="p-3"><div class="flex items-center">${radioButtons}</div></td>
                        </tr>
                    `;
                });
            }


            // Mengisi filter kelas
            function populateFilterKelas() {
                const kelasSet = new Set(dataSiswa.map(s => s.kelas));
                filterKelas.innerHTML = '<option value="all">Semua Kelas</option>';
                [...kelasSet].sort().forEach(kelas => {
                    filterKelas.innerHTML += `<option value="${kelas}">${kelas}</option>`;
                });
            }

            function populateLaporanFilterKelas() {
                const filterLaporan = document.getElementById('filter-kelas-laporan');
                const kelasSet = new Set(dataSiswa.map(s => s.kelas));
                filterLaporan.innerHTML = '<option value="all">Semua Kelas</option>';
                [...kelasSet].sort().forEach(kelas => {
                    filterLaporan.innerHTML += `<option value="${kelas}">${kelas}</option>`;
                });
            }
            
            function populateFilterKelasDataSiswa() {
                const filter = document.getElementById('filter-kelas-data-siswa');
                const kelasSet = new Set(dataSiswa.map(s => s.kelas));
                filter.innerHTML = '<option value="all">Semua Kelas</option>';
                [...kelasSet].sort().forEach(kelas => {
                    filter.innerHTML += `<option value="${kelas}">${kelas}</option>`;
                });
            }
            
            // Handle File Upload
            async function handleFileUpload(event, type) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);

                    try {
                        let changes = [];
                        if (type === 'guru') {
                            json.forEach(row => {
                                if (row['Nama Guru'] && row['Jabatan']) {
                                    changes.push({ 
                                        action: 'addGuru', 
                                        data: {
                                            id: Date.now() + Math.random(),
                                            nama: row['Nama Guru'],
                                            jabatan: row['Jabatan'],
                                        }
                                    });
                                }
                            });
                        } else if (type === 'siswa') {
                             json.forEach(row => {
                                if (row['NIS'] && row['Nama Siswa'] && row['Kelas'] && !dataSiswa.some(s => s.nis == row['NIS'])) {
                                    changes.push({
                                        action: 'addSiswa',
                                        data: {
                                            nis: String(row['NIS']),
                                            nisn: String(row['NISN'] || ''),
                                            nama: row['Nama Siswa'],
                                            kelas: row['Kelas'],
                                        }
                                    });
                                }
                            });
                        }
                        
                        if (changes.length > 0) {
                            const success = await postData({ action: 'processBulkDataChanges', changes: changes });
                            if (success) {
                                alert(`${changes.length} data baru berhasil diimpor! Data akan diperbarui.`);
                                fetchDataAndUpdate(true); // Fetch all data again to ensure sync
                            }
                        } else {
                            alert('Tidak ada data baru untuk diimpor atau data sudah ada (berdasarkan NIS).');
                        }

                    } catch (error) {
                        alert('Gagal mengimpor data. Pastikan format kolom file Excel Anda benar.\nUntuk Guru: "Nama Guru", "Jabatan".\nUntuk Siswa: "NIS", "NISN", "Nama Siswa", "Kelas".');
                        console.error("Error parsing Excel file:", error);
                    }
                };
                reader.readAsArrayBuffer(file);
                event.target.value = '';
            }


            // --- EVENT LISTENERS ---
            function setupEventListeners() {
                document.getElementById('login-btn').addEventListener('click', handleLogin);
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
                
                // Image Upload Listeners
                const logoContainer = document.getElementById('logo-container');
                const logoInput = document.getElementById('logo-input');
                const schoolLogo = document.getElementById('school-logo');
                
                const profileImageContainer = document.getElementById('profile-image-container');
                const profileInput = document.getElementById('profile-input');
                const profileImg = document.getElementById('profile-img');

                const loginLogoContainer = document.getElementById('login-logo-container');
                const loginLogoInput = document.getElementById('login-logo-input');
                const loginSchoolLogo = document.getElementById('login-school-logo');

                logoContainer.addEventListener('click', () => logoInput.click());
                loginLogoContainer.addEventListener('click', () => loginLogoInput.click());

                const handleLogoUpload = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const imageUrl = e.target.result;
                            localStorage.setItem('schoolLogo', imageUrl);
                            
                            // Update both logos
                            schoolLogo.src = imageUrl;
                            schoolLogo.classList.remove('hidden');
                            document.getElementById('logo-placeholder').classList.add('hidden');

                            loginSchoolLogo.src = imageUrl;
                            loginSchoolLogo.classList.remove('hidden');
                            document.getElementById('login-logo-placeholder').classList.add('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                };

                logoInput.addEventListener('change', handleLogoUpload);
                loginLogoInput.addEventListener('change', handleLogoUpload);

                profileImageContainer.addEventListener('click', () => profileInput.click());
                profileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const imageUrl = e.target.result;
                            profileImg.src = imageUrl;
                            profileImg.classList.remove('hidden');
                            document.getElementById('profile-placeholder').classList.add('hidden');
                            localStorage.setItem('profileImage', imageUrl);
                        };
                        reader.readAsDataURL(file);
                    }
                });


                filterKelas.addEventListener('change', (e) => {
                    muatAbsensiSiswa(e.target.value);
                });

                document.getElementById('filter-kelas-data-siswa').addEventListener('change', (e) => {
                    muatDataSiswaTabel(e.target.value);
                });

                document.getElementById('filter-kelas-laporan').addEventListener('change', (e) => {
                    muatLaporanHarianSiswa(e.target.value);
                });

                document.getElementById('tabel-absensi-siswa').addEventListener('click', async (e) => {
                    if (e.target.classList.contains('attendance-radio')) {
                        const nis = e.target.dataset.nis;
                        const status = e.target.value;
                        
                        const success = await postData({ action: 'updateSiswaStatus', nis, status });
                        if(success) {
                            // Update cache data master lokal
                            const siswa = dataSiswa.find(s => s.nis === nis);
                            if (siswa) siswa.status = status;
                            
                            const today = new Date().getDate();
                            const headers = (rekapSiswa && rekapSiswa.length > 0) ? rekapSiswa[0] : [];
                            const dateColumnIndex = headers.indexOf(today) > -1 ? headers.indexOf(today) : headers.indexOf(String(today));

                            if (dateColumnIndex !== -1) {
                                const rekapRowIndex = rekapSiswa.findIndex(row => String(row[0]) === String(nis));
                                if (rekapRowIndex > 0) {
                                    rekapSiswa[rekapRowIndex][dateColumnIndex] = status.charAt(0).toUpperCase();
                                }
                            }
                            // Refresh dasbor untuk update grafik secara realtime
                            if(!document.getElementById('beranda-page').classList.contains('hidden')) {
                                renderChartsForPage('beranda');
                            }
                        } else {
                            // Jika gagal, muat ulang data absensi untuk mengembalikan ke status semula
                            muatAbsensiSiswa(document.getElementById('filter-kelas').value);
                        }
                    }
                });

                 document.getElementById('tabel-absensi-guru').addEventListener('click', async (e) => {
                    if (e.target.classList.contains('attendance-radio-guru')) {
                        const id = e.target.dataset.id;
                        const status = e.target.value;
                        
                        const success = await postData({ action: 'updateGuruStatus', id, status });
                        if (success) {
                            const guru = dataGuru.find(g => g.id == id);
                            if (guru) guru.status = status;

                            const today = new Date().getDate();
                            const headers = (rekapGuru && rekapGuru.length > 0) ? rekapGuru[0] : [];
                            const dateColumnIndex = headers.indexOf(today) > -1 ? headers.indexOf(today) : headers.indexOf(String(today));
                            
                            if (dateColumnIndex !== -1) {
                                const rekapRowIndex = rekapGuru.findIndex(row => String(row[0]) === String(id));
                                if (rekapRowIndex > 0) {
                                    rekapGuru[rekapRowIndex][dateColumnIndex] = status.charAt(0).toUpperCase();
                                }
                            }
                            
                            if(!document.getElementById('beranda-page').classList.contains('hidden')) {
                                renderChartsForPage('beranda');
                            }
                        } else {
                            muatAbsensiGuru();
                        }
                    }
                });
                
                // Laporan Page Listeners
                const reportTabs = [
                    { btn: 'laporan-siswa-tab', content: 'laporan-siswa-content'},
                    { btn: 'laporan-guru-tab', content: 'laporan-guru-content'},
                ];

                reportTabs.forEach(tabInfo => {
                    const tabButton = document.getElementById(tabInfo.btn);
                    if (tabButton) {
                        tabButton.addEventListener('click', () => {
                            reportTabs.forEach(t => {
                                const content = document.getElementById(t.content);
                                if(content) content.classList.add('hidden');
                            });
                            reportTabs.forEach(t => {
                                const btn = document.getElementById(t.btn);
                                if (btn) {
                                    btn.classList.remove('border-blue-500', 'text-blue-600');
                                    btn.classList.add('border-transparent', 'text-gray-500');
                                }
                            });
                            const activeContent = document.getElementById(tabInfo.content);
                            if(activeContent) activeContent.classList.remove('hidden');
                            tabButton.classList.add('border-blue-500', 'text-blue-600');
                            tabButton.classList.remove('border-transparent', 'text-gray-500');
                        });
                    }
                });

                document.getElementById('download-siswa-pdf').addEventListener('click', () => downloadMonthlyPDF('siswa'));
                document.getElementById('download-guru-pdf').addEventListener('click', () => downloadMonthlyPDF('guru'));
                
                document.getElementById('mobile-menu-btn').addEventListener('click', () => {
                    document.getElementById('mobile-menu').classList.toggle('hidden');
                });
                
                // Menu navigation
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const page = e.currentTarget.dataset.page;
                        if (page) {
                            tampilHalaman(page);
                            document.getElementById('mobile-menu').classList.add('hidden');
                            const dropdownMenu = document.getElementById('absensi-dropdown-menu');
                            if (dropdownMenu) {
                                dropdownMenu.classList.add('hidden');
                            }
                        }
                    });
                });

                // Absensi Dropdown Listener
                const dropdownBtn = document.getElementById('absensi-dropdown-btn');
                const dropdownMenu = document.getElementById('absensi-dropdown-menu');
                dropdownBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dropdownMenu.classList.toggle('hidden');
                    const icon = dropdownBtn.querySelector('svg');
                    if(icon) icon.classList.toggle('rotate-180');
                });

                document.addEventListener('click', () => {
                    const dropdownBtn = document.getElementById('absensi-dropdown-btn');
                    if (dropdownMenu && !dropdownMenu.classList.contains('hidden')) {
                        dropdownMenu.classList.add('hidden');
                        const icon = dropdownBtn.querySelector('svg');
                        if (icon) icon.classList.remove('rotate-180');
                    }
                });


                // Guru Form Listeners
                document.getElementById('tambah-guru-manual').addEventListener('click', () => {
                    document.getElementById('guru-form').reset();
                    document.getElementById('guru-id').value = '';
                    document.getElementById('tambah-guru-page-title').textContent = 'Tambah Guru Baru';
                    document.getElementById('simpan-guru-btn').textContent = 'Tambah';
                    tampilHalaman('tambah-guru');
                });

                document.getElementById('batal-guru').addEventListener('click', () => tampilHalaman('guru'));

                document.getElementById('guru-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const id = document.getElementById('guru-id').value;
                    const nama = document.getElementById('guru-nama').value;
                    const jabatan = document.getElementById('guru-jabatan').value;

                    const change = id 
                        ? { action: 'editGuru', data: { id, nama, jabatan } }
                        : { action: 'addGuru', data: { id: Date.now(), nama, jabatan } };
                    
                    guruPendingChanges.push(change);
                    // Optimistic UI update
                    if(id) {
                         Object.assign(dataGuru.find(g => g.id == id), { nama, jabatan });
                    } else {
                        dataGuru.push(change.data);
                    }
                    refreshUI();
                    tampilHalaman('guru');
                    updateSaveButtonsUI();
                });

                document.getElementById('tabel-guru').addEventListener('click', (e) => {
                    const editBtn = e.target.closest('.edit-guru');
                    const deleteBtn = e.target.closest('.hapus-guru');
                    
                    if (editBtn) {
                        const id = editBtn.dataset.id;
                        const guru = dataGuru.find(g => g.id == id);
                        if (guru) {
                            document.getElementById('guru-id').value = guru.id;
                            document.getElementById('guru-nama').value = guru.nama;
                            document.getElementById('guru-jabatan').value = guru.jabatan;
                            document.getElementById('tambah-guru-page-title').textContent = 'Edit Data Guru';
                            document.getElementById('simpan-guru-btn').textContent = 'Simpan';
                            tampilHalaman('tambah-guru');
                        }
                    }

                    if (deleteBtn) {
                        const id = deleteBtn.dataset.id;
                        deleteCallback = () => {
                            guruPendingChanges.push({ action: 'deleteGuru', id });
                            dataGuru = dataGuru.filter(g => g.id != id);
                            refreshUI();
                            hideModal(confirmModal);
                            updateSaveButtonsUI();
                        };
                        document.getElementById('confirm-title').textContent = 'Hapus Data';
                        document.getElementById('confirm-message').textContent = 'Apakah Anda yakin ingin menghapus data ini? Tindakan ini tidak dapat dibatalkan.';
                        showModal(confirmModal);
                    }
                });

                document.getElementById('simpan-perubahan-guru').addEventListener('click', async () => {
                    if (guruPendingChanges.length === 0) return;
                    const success = await postData({ action: 'processBulkDataChanges', changes: guruPendingChanges });
                    if (success) {
                        guruPendingChanges = [];
                        updateSaveButtonsUI();
                        alert('Perubahan data guru berhasil disimpan!');
                        await fetchDataAndUpdate(true);
                    }
                });
                
                document.getElementById('simpan-perubahan-siswa').addEventListener('click', async () => {
                    if (siswaPendingChanges.length === 0) return;
                    const success = await postData({ action: 'processBulkDataChanges', changes: siswaPendingChanges });
                    if (success) {
                        siswaPendingChanges = [];
                        updateSaveButtonsUI();
                        alert('Perubahan data siswa berhasil disimpan!');
                        await fetchDataAndUpdate(true);
                    }
                });

                // Siswa Form Listeners
                document.getElementById('tambah-siswa-manual').addEventListener('click', () => {
                    document.getElementById('siswa-form').reset();
                    document.getElementById('siswa-nis-edit').value = '';
                    document.getElementById('siswa-nis').disabled = false;
                    document.getElementById('tambah-siswa-page-title').textContent = 'Tambah Siswa Baru';
                    tampilHalaman('tambah-siswa');
                });

                document.getElementById('batal-siswa').addEventListener('click', () => tampilHalaman('data-siswa'));

                document.getElementById('siswa-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const nisEdit = document.getElementById('siswa-nis-edit').value;
                    const nis = document.getElementById('siswa-nis').value;
                    const nisn = document.getElementById('siswa-nisn').value;
                    const nama = document.getElementById('siswa-nama').value;
                    const kelas = document.getElementById('siswa-kelas').value;
                    
                    const data = { nis, nisn, nama, kelas };
                    const change = nisEdit
                        ? { action: 'editSiswa', data }
                        : { action: 'addSiswa', data };

                    if (!nisEdit && dataSiswa.some(s => s.nis === nis)) {
                        alert('NIS sudah ada. Silakan gunakan NIS yang lain.');
                        return;
                    }
                    
                    siswaPendingChanges.push(change);
                    // Optimistic UI update
                     if(nisEdit) {
                         Object.assign(dataSiswa.find(s => s.nis === nisEdit), data);
                    } else {
                        dataSiswa.push(data);
                    }
                    refreshUI();
                    tampilHalaman('data-siswa');
                    updateSaveButtonsUI();
                });
                
                document.getElementById('tabel-data-siswa').addEventListener('click', (e) => {
                    const editBtn = e.target.closest('.edit-siswa');
                    const deleteBtn = e.target.closest('.hapus-siswa');
                    if (editBtn) {
                        const nis = editBtn.dataset.nis;
                        const siswa = dataSiswa.find(s => s.nis === nis);
                        if (siswa) {
                            document.getElementById('siswa-nis-edit').value = siswa.nis;
                            document.getElementById('siswa-nis').value = siswa.nis;
                            document.getElementById('siswa-nis').disabled = true;
                            document.getElementById('siswa-nisn').value = siswa.nisn;
                            document.getElementById('siswa-nama').value = siswa.nama;
                            document.getElementById('siswa-kelas').value = siswa.kelas;
                            document.getElementById('tambah-siswa-page-title').textContent = 'Edit Data Siswa';
                            tampilHalaman('tambah-siswa');
                        }
                    }
                    if (deleteBtn) {
                        const nis = deleteBtn.dataset.nis;
                        deleteCallback = () => {
                            siswaPendingChanges.push({ action: 'deleteSiswa', nis });
                            dataSiswa = dataSiswa.filter(s => s.nis != nis);
                            refreshUI();
                            hideModal(confirmModal);
                            updateSaveButtonsUI();
                        };
                        document.getElementById('confirm-title').textContent = 'Hapus Data Siswa';
                        document.getElementById('confirm-message').textContent = 'Apakah Anda yakin ingin menghapus data siswa ini? Tindakan ini tidak dapat dibatalkan.';
                        showModal(confirmModal);
                    }
                });
            
                // Event listener for holiday settings
                document.getElementById('holiday-calendar-table').addEventListener('change', (e) => {
                    if (e.target.classList.contains('holiday-checkbox')) {
                        const day = e.target.dataset.day;
                        const checkbox = e.target;
                        const isHolidayChecked = checkbox.checked;
                        const now = new Date();
                        const dateString = `${now.getFullYear()}-${now.getMonth() + 1}-${day}`;

                        // --- Optimistic UI Update ---
                        // Perbarui status libur di aplikasi secara langsung agar terasa instan
                        if (isHolidayChecked) {
                            manualHolidays.add(dateString);
                        } else {
                            manualHolidays.delete(dateString);
                        }
                        // Perbarui menu yang mungkin terpengaruh oleh status hari libur
                        updateUIForRole();

                        // --- Asynchronous Backend Update (tanpa loading spinner) ---
                        postData({
                            action: 'setHoliday',
                            date: dateString,
                            isHoliday: isHolidayChecked
                        }, false).then(success => { // Kirim 'false' untuk mencegah loading spinner
                            if (success) {
                                // Data berhasil disimpan. Lakukan sinkronisasi data di latar belakang.
                                fetchDataAndUpdate(false);
                            } else {
                                // Jika postData gagal, notifikasi sudah ditampilkan.
                                // Kembalikan perubahan pada UI.
                                checkbox.checked = !isHolidayChecked;
                                if (!isHolidayChecked) {
                                    manualHolidays.add(dateString);
                                } else {
                                    manualHolidays.delete(dateString);
                                }
                                updateUIForRole();
                            }
                        });
                    }
                });

                document.getElementById('upload-guru-excel').addEventListener('click', () => document.getElementById('guru-file-input').click());
                document.getElementById('guru-file-input').addEventListener('change', (e) => handleFileUpload(e, 'guru'));
                document.getElementById('upload-siswa-excel').addEventListener('click', () => document.getElementById('siswa-file-input').click());
                document.getElementById('siswa-file-input').addEventListener('change', (e) => handleFileUpload(e, 'siswa'));

                // Modal listeners
                document.getElementById('confirm-cancel').addEventListener('click', () => hideModal(confirmModal));
                document.getElementById('confirm-delete').addEventListener('click', () => {
                    if (deleteCallback) deleteCallback();
                });
                
                // Bulk delete listeners
                document.getElementById('select-all-siswa').addEventListener('change', (e) => {
                    document.querySelectorAll('.siswa-checkbox').forEach(cb => {
                        cb.checked = e.target.checked;
                    });
                    updateBulkActionUI();
                });

                document.getElementById('tabel-data-siswa').addEventListener('change', (e) => {
                    if (e.target.classList.contains('siswa-checkbox')) {
                        updateBulkActionUI();
                    }
                });

                document.getElementById('hapus-terpilih-btn').addEventListener('click', () => {
                    const selectedCheckboxes = document.querySelectorAll('.siswa-checkbox:checked');
                    if (selectedCheckboxes.length === 0) return;

                    deleteCallback = () => {
                        selectedCheckboxes.forEach(cb => {
                            const nis = cb.dataset.nis;
                            siswaPendingChanges.push({ action: 'deleteSiswa', nis });
                        });
                        const selectedNis = Array.from(selectedCheckboxes).map(cb => cb.dataset.nis);
                        dataSiswa = dataSiswa.filter(s => !selectedNis.includes(s.nis));

                        refreshUI();
                        hideModal(confirmModal);
                        updateSaveButtonsUI();
                    };
                    document.getElementById('confirm-title').textContent = `Hapus ${selectedCheckboxes.length} Data Siswa`;
                    document.getElementById('confirm-message').textContent = 'Apakah Anda yakin ingin menghapus semua data yang dipilih?';
                    showModal(confirmModal);
                });
            }

            function updateSaveButtonsUI() {
                const saveGuruBtn = document.getElementById('simpan-perubahan-guru');
                const saveSiswaBtn = document.getElementById('simpan-perubahan-siswa');
                if (!saveGuruBtn || !saveSiswaBtn) return;

                if (currentUserRole === 'Administrator') {
                    saveGuruBtn.style.display = guruPendingChanges.length > 0 ? 'flex' : 'none';
                    saveSiswaBtn.style.display = siswaPendingChanges.length > 0 ? 'flex' : 'none';
                } else {
                    saveGuruBtn.style.display = 'none';
                    saveSiswaBtn.style.display = 'none';
                }
            }

            // Fungsi untuk menampilkan/menyembunyikan tombol admin
            function updateAdminUI() {
                const isAdmin = currentUserRole === 'Administrator';
                
                // Tampilkan/sembunyikan kontainer pengaturan hari libur
                const holidayContainer = document.getElementById('holiday-settings-container');
                if (holidayContainer) {
                    holidayContainer.style.display = isAdmin ? 'block' : 'none';
                    if (isAdmin) {
                        generateHolidayCalendar(); // Generate kalender jika admin
                    }
                }

                const adminButtons = [
                    'tambah-guru-manual',
                    'upload-guru-excel',
                    'tambah-siswa-manual',
                    'upload-siswa-excel'
                ];
                adminButtons.forEach(id => {
                    const button = document.getElementById(id);
                    if (button) {
                        button.style.display = isAdmin ? 'flex' : 'none';
                    }
                });

                const aksiKolomElements = document.querySelectorAll('.aksi-kolom');
                aksiKolomElements.forEach(el => {
                    el.style.display = isAdmin ? '' : 'none';
                });
                
                const aksiKolomAdminElements = document.querySelectorAll('.aksi-kolom-admin');
                aksiKolomAdminElements.forEach(el => {
                    el.style.display = isAdmin ? '' : 'none';
                });

                updateBulkActionUI();
                updateSaveButtonsUI();
            }

            function updateBulkActionUI() {
                const container = document.getElementById('bulk-action-container');
                if (!container) return;
                const checkedCount = document.querySelectorAll('.siswa-checkbox:checked').length;
                const isAdmin = currentUserRole === 'Administrator';

                if (isAdmin && checkedCount > 0) {
                    container.style.display = 'flex';
                } else {
                    container.style.display = 'none';
                }
            }

            // --- Fungsi Tambahan untuk Kalender Libur ---
            function generateHolidayCalendar() {
                const table = document.getElementById('holiday-calendar-table');
                if (!table) return;

                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                let headerHtml = '<thead><tr class="bg-gray-100"><th class="p-2 border">Tanggal</th>';
                let bodyHtml = '<tbody><tr><td class="p-2 border font-semibold">Libur</td>';

                const holidayStatus = new Set();
                if (rekapSiswa.length > 1) {
                    const headers = rekapSiswa[0];
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateColumnIndex = headers.indexOf(day) > -1 ? headers.indexOf(day) : headers.indexOf(String(day));
                        if (dateColumnIndex > -1) {
                            const isDayOffForAll = rekapSiswa.slice(1).every(row => row[dateColumnIndex] === '-');
                            if (isDayOffForAll) {
                                holidayStatus.add(day);
                            }
                        }
                    }
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                    const isCheckedBySystem = isHoliday(date);
                    const isCheckedManually = holidayStatus.has(i);

                    headerHtml += `<th class="p-2 border font-normal ${isWeekend ? 'bg-red-100' : ''}">${i}</th>`;
                    bodyHtml += `
                        <td class="p-2 border ${isWeekend ? 'bg-red-50' : ''}">
                            <input type="checkbox" class="holiday-checkbox h-5 w-5 rounded border-gray-400 text-blue-600 focus:ring-blue-500 cursor-pointer" 
                                   data-day="${i}" 
                                   ${isCheckedBySystem || isCheckedManually ? 'checked' : ''}
                                   ${isWeekend ? 'disabled' : ''}
                                   title="${isWeekend ? 'Akhir Pekan' : 'Setel sebagai hari libur'}">
                        </td>
                    `;
                }

                headerHtml += '</tr></thead>';
                bodyHtml += '</tr></tbody>';

                table.innerHTML = headerHtml + bodyHtml;
            }


            // --- FUNGSI-FUNGSI GRAFIK (Menggunakan Google Charts) ---
             function createAbsenceTable(sakit, izin, alpha) {
                return `
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th scope="col" class="px-4 py-2">Status Absen</th>
                                <th scope="col" class="px-4 py-2 text-right">Jumlah</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-white border-b">
                                <td class="px-4 py-1 font-medium">Sakit</td>
                                <td class="px-4 py-1 text-right font-bold">${sakit}</td>
                            </tr>
                            <tr class="bg-gray-50 border-b">
                                <td class="px-4 py-1 font-medium">Izin</td>
                                <td class="px-4 py-1 text-right font-bold">${izin}</td>
                            </tr>
                            <tr class="bg-white">
                                <td class="px-4 py-1 font-medium">Alpha</td>
                                <td class="px-4 py-1 text-right font-bold">${alpha}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                `;
            }

            function updateDashboardCards() {
                document.getElementById('total-siswa').textContent = dataSiswa.length;
                
                let hadir = 0, izin = 0, sakit = 0, alpha = 0;

                if (rekapSiswa && rekapSiswa.length > 1) {
                    const today = new Date();
                    const currentDay = today.getDate();
                    const headers = rekapSiswa[0];
                    const dateColumnIndex = headers.indexOf(currentDay) > -1 ? headers.indexOf(currentDay) : headers.indexOf(String(currentDay));
                    
                    if (dateColumnIndex !== -1) {
                        for (let i = 1; i < rekapSiswa.length; i++) {
                            const row = rekapSiswa[i];
                            const status = String(row[dateColumnIndex] || '').toUpperCase();
                            
                            if (status.startsWith('H')) hadir++;
                            else if (status.startsWith('I')) izin++;
                            else if (status.startsWith('S')) sakit++;
                            else if (status.startsWith('A')) alpha++;
                        }
                    }
                }

                document.getElementById('total-hadir').textContent = hadir;
                document.getElementById('total-izin').textContent = izin;
                document.getElementById('total-sakit').textContent = sakit;
                document.getElementById('total-alpha').textContent = alpha;
            }

            function renderPerClassCharts() {
                const container = document.getElementById('per-class-charts-container');
                container.innerHTML = ''; 

                const allClasses = [...new Set(dataSiswa.map(s => s.kelas))].sort();

                if (allClasses.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 md:col-span-2 xl:col-span-3 text-center">Belum ada data siswa untuk ditampilkan.</p>';
                    return;
                }

                allClasses.forEach(kelas => {
                    const siswaDiKelas = dataSiswa.filter(s => s.kelas === kelas);
                    const totalSiswaDiKelas = siswaDiKelas.length;
                    const chartId = `chart-kelas-${kelas.replace(/\s+/g, '-')}`;
                    const tableId = `table-chart-kelas-${kelas.replace(/\s+/g, '-')}`;

                    container.innerHTML += `
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-semibold text-gray-800">Kelas ${kelas}</h3>
                                <p class="text-sm text-gray-500 font-medium">${totalSiswaDiKelas} Siswa</p>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 items-center">
                                <div id="${chartId}" style="width: 100%; height: 250px;"></div>
                                <div id="${tableId}"></div>
                            </div>
                        </div>
                    `;
                });

                allClasses.forEach(kelas => {
                    const siswaDiKelas = dataSiswa.filter(s => s.kelas === kelas);
                    let hadir = 0, sakit = 0, izin = 0, alpha = 0;

                    if (rekapSiswa && rekapSiswa.length > 1) {
                        const today = new Date();
                        const currentDay = today.getDate();
                        const headers = rekapSiswa[0];
                        const dateColumnIndex = headers.indexOf(currentDay) > -1 ? headers.indexOf(currentDay) : headers.indexOf(String(currentDay));
                        const nisColumnIndex = headers.indexOf('NIS');

                        if (dateColumnIndex !== -1 && nisColumnIndex !== -1) {
                            const nisInKelas = new Set(siswaDiKelas.map(s => String(s.nis)));
                            for (let i = 1; i < rekapSiswa.length; i++) {
                                const row = rekapSiswa[i];
                                if (nisInKelas.has(String(row[nisColumnIndex]))) {
                                    const status = String(row[dateColumnIndex] || '').toUpperCase();
                                    if (status.startsWith('H')) hadir++;
                                    else if (status.startsWith('S')) sakit++;
                                    else if (status.startsWith('I')) izin++;
                                    else if (status.startsWith('A')) alpha++;
                                }
                            }
                        }
                    }
                    
                    const total = hadir + sakit + izin + alpha;
                    
                    const data = google.visualization.arrayToDataTable([
                        ['Status', 'Jumlah', { role: 'style' }, { role: 'annotation' }],
                        ['Hadir', hadir, '#34D399', total > 0 ? `${(hadir/total*100).toFixed(0)}%` : '0%'],
                        ['Sakit', sakit, '#F87171', total > 0 ? `${(sakit/total*100).toFixed(0)}%` : '0%'],
                        ['Izin', izin, '#FBBF24', total > 0 ? `${(izin/total*100).toFixed(0)}%` : '0%'],
                        ['Alpha', alpha, '#9CA3AF', total > 0 ? `${(alpha/total*100).toFixed(0)}%` : '0%']
                    ]);
                    
                    const isMobile = window.innerWidth < 768;
                    const options = {
                        legend: { position: "none" },
                        backgroundColor: 'transparent',
                        chartArea: { 
                            width: isMobile ? '70%' : '85%', 
                            height: '80%' 
                        },
                        hAxis: { 
                            textStyle: { fontSize: isMobile ? 9 : 11 },
                            slantedText: isMobile,
                            slantedTextAngle: 45 
                        },
                        vAxis: { 
                            gridlines: { color: 'transparent' }, 
                            format: '0' 
                        },
                        annotations: { 
                            textStyle: { 
                                fontSize: isMobile ? 9 : 11, 
                                bold: true, 
                                color: '#333' 
                            }, 
                            alwaysOutside: true 
                        },
                    };
                    
                    const chart = new google.visualization.ColumnChart(document.getElementById(`chart-kelas-${kelas.replace(/\s+/g, '-')}`));
                    chart.draw(data, options);

                    // Render table
                    const tableId = `table-chart-kelas-${kelas.replace(/\s+/g, '-')}`;
                    document.getElementById(tableId).innerHTML = createAbsenceTable(sakit, izin, alpha);
                });
            }

            function renderMonthlyPerClassCharts() {
                const container = document.getElementById('monthly-per-class-charts-container');
                container.innerHTML = '';

                const allClasses = [...new Set(dataSiswa.map(s => s.kelas))].sort();

                if (allClasses.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 md:col-span-2 xl:col-span-3 text-center">Belum ada data siswa untuk ditampilkan.</p>';
                    return;
                }

                const headers = (rekapSiswa && rekapSiswa.length > 0) ? rekapSiswa[0] : [];
                const nisColumnIndex = headers.indexOf('NIS');
                const hSummaryIndex = headers.indexOf('Jumlah H');
                const sSummaryIndex = headers.indexOf('Jumlah S');
                const iSummaryIndex = headers.indexOf('Jumlah I');
                const aSummaryIndex = headers.indexOf('Jumlah A');
                
                // Perbaikan: Lakukan validasi berdasarkan kolom 'NIS' yang esensial untuk mencocokkan data.
                if (nisColumnIndex === -1) {
                    container.innerHTML = '<p class="text-gray-500 md:col-span-2 xl:col-span-3 text-center">Format data rekap bulanan tidak valid (Kolom "NIS" tidak ditemukan).</p>';
                    return;
                }

                // Buat Map untuk pencarian data rekap yang efisien berdasarkan NIS
                const rekapSiswaMap = new Map();
                if (rekapSiswa.length > 1) {
                    rekapSiswa.slice(1).forEach(row => {
                        if(row && row.length > nisColumnIndex) rekapSiswaMap.set(String(row[nisColumnIndex]), row);
                    });
                }
                
                allClasses.forEach(kelas => {
                    const totalSiswaDiKelas = dataSiswa.filter(s => s.kelas === kelas).length;
                    const chartId = `monthly-chart-kelas-${kelas.replace(/\s+/g, '-')}`;
                    const tableId = `table-monthly-chart-kelas-${kelas.replace(/\s+/g, '-')}`;

                    let [hadir, sakit, izin, alpha] = [0, 0, 0, 0];

                    // Ambil siswa dari data master, lalu cari data rekap mereka melalui Map
                    const siswaDiKelas = dataSiswa.filter(s => s.kelas === kelas);
                    siswaDiKelas.forEach(siswa => {
                        const rekapRow = rekapSiswaMap.get(String(siswa.nis));
                        if (rekapRow) {
                            if (hSummaryIndex > -1 && rekapRow.length > hSummaryIndex) hadir += parseInt(rekapRow[hSummaryIndex]) || 0;
                            if (sSummaryIndex > -1 && rekapRow.length > sSummaryIndex) sakit += parseInt(rekapRow[sSummaryIndex]) || 0;
                            if (iSummaryIndex > -1 && rekapRow.length > iSummaryIndex) izin += parseInt(rekapRow[iSummaryIndex]) || 0;
                            if (aSummaryIndex > -1 && rekapRow.length > aSummaryIndex) alpha += parseInt(rekapRow[aSummaryIndex]) || 0;
                        }
                    });

                    const cardHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800">Kelas ${kelas}</h3>
                                    <p class="text-sm text-gray-500 font-medium">${totalSiswaDiKelas} Siswa</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-500">Total Hadir Bulan Ini</p>
                                    <p class="text-2xl font-bold text-green-600">${hadir}</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 items-center mt-4">
                                <div id="${chartId}" style="width: 100%; height: 250px;"></div>
                                <div id="${tableId}"></div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += cardHTML;

                    // Defer chart drawing to ensure the element exists in the DOM
                    setTimeout(() => {
                        const total = hadir + sakit + izin + alpha;
                        const data = google.visualization.arrayToDataTable([
                            ['Status', 'Jumlah', { role: 'style' }, { role: 'annotation' }],
                            ['Hadir', hadir, '#3B82F6', total > 0 ? `${(hadir/total*100).toFixed(0)}%` : '0%'],
                            ['Sakit', sakit, '#F87171', total > 0 ? `${(sakit/total*100).toFixed(0)}%` : '0%'],
                            ['Izin', izin, '#FBBF24', total > 0 ? `${(izin/total*100).toFixed(0)}%` : '0%'],
                            ['Alpha', alpha, '#9CA3AF', total > 0 ? `${(alpha/total*100).toFixed(0)}%` : '0%']
                        ]);

                        const isMobile = window.innerWidth < 768;
                        const options = {
                            legend: { position: "none" },
                            backgroundColor: 'transparent',
                            chartArea: { 
                                width: isMobile ? '70%' : '85%', 
                                height: '80%' 
                            },
                             hAxis: { 
                                textStyle: { fontSize: isMobile ? 9 : 11 },
                                slantedText: isMobile,
                                slantedTextAngle: 45 
                            },
                            vAxis: { 
                                gridlines: { color: 'transparent' } 
                            },
                            annotations: { 
                                textStyle: { 
                                    fontSize: isMobile ? 9 : 11, 
                                    bold: true, 
                                    color: '#333' 
                                }, 
                                alwaysOutside: true 
                            },
                        };

                        const chartEl = document.getElementById(chartId);
                        if (chartEl) {
                           const chart = new google.visualization.ColumnChart(chartEl);
                           chart.draw(data, options);
                        }

                        const tableEl = document.getElementById(tableId);
                        if (tableEl) {
                           tableEl.innerHTML = createAbsenceTable(sakit, izin, alpha);
                        }
                    }, 0);
                });
            }

            function renderOverallDailyPieChart() {
                let hadir = 0, sakit = 0, izin = 0, alpha = 0;
                
                if (rekapSiswa && rekapSiswa.length > 1) {
                    const today = new Date();
                    const currentDay = today.getDate();
                    const headers = rekapSiswa[0];
                    const dateColumnIndex = headers.indexOf(currentDay) > -1 ? headers.indexOf(currentDay) : headers.indexOf(String(currentDay));
                    
                    if (dateColumnIndex !== -1) {
                        for (let i = 1; i < rekapSiswa.length; i++) {
                            const row = rekapSiswa[i];
                            const status = String(row[dateColumnIndex] || '').toUpperCase();
                            
                            if (status.startsWith('H')) hadir++;
                            else if (status.startsWith('S')) sakit++;
                            else if (status.startsWith('I')) izin++;
                            else if (status.startsWith('A')) alpha++;
                        }
                    }
                }
                const total = hadir + sakit + izin + alpha;

                const data = google.visualization.arrayToDataTable([
                    ['Status', 'Jumlah', { role: 'style' }, { role: 'annotation' }],
                    ['Hadir', hadir, '#34D399', total > 0 ? `${(hadir/total*100).toFixed(0)}%` : '0%'],
                    ['Sakit', sakit, '#F87171', total > 0 ? `${(sakit/total*100).toFixed(0)}%` : '0%'],
                    ['Izin', izin, '#FBBF24', total > 0 ? `${(izin/total*100).toFixed(0)}%` : '0%'],
                    ['Alpha', alpha, '#9CA3AF', total > 0 ? `${(alpha/total*100).toFixed(0)}%` : '0%']
                ]);

                const isMobile = window.innerWidth < 768;
                const options = {
                    legend: { position: "none" },
                    backgroundColor: 'transparent',
                    chartArea: {
                        width: '85%',
                        height: '80%'
                    },
                    hAxis: {
                        textStyle: { fontSize: isMobile ? 10 : 12 }
                    },
                    vAxis: {
                        gridlines: { color: 'transparent' },
                        format: '0'
                    },
                    annotations: {
                        textStyle: {
                            fontSize: 12,
                            bold: true,
                            color: '#333'
                        },
                        alwaysOutside: true
                    },
                };
                
                const chart = new google.visualization.ColumnChart(document.getElementById('overall-daily-pie-chart'));
                chart.draw(data, options);
            }

            function renderOverallMonthlyPieChart() {
                let hadir = 0, sakit = 0, izin = 0, alpha = 0;
                
                if (!rekapSiswa || rekapSiswa.length < 2) { /* Handle empty data */ } else {
                    const headers = rekapSiswa[0];
                    const summaryHIndex = headers.indexOf('Jumlah H');
                    const summarySIndex = headers.indexOf('Jumlah S');
                    const summaryIIndex = headers.indexOf('Jumlah I');
                    const summaryAIndex = headers.indexOf('Jumlah A');
                    
                    if(summaryHIndex > -1){
                        for (let i = 1; i < rekapSiswa.length; i++) {
                            const row = rekapSiswa[i];
                             if (row[0]) { 
                                hadir += parseInt(row[summaryHIndex]) || 0;
                                sakit += parseInt(row[summarySIndex]) || 0;
                                izin += parseInt(row[summaryIIndex]) || 0;
                                alpha += parseInt(row[summaryAIndex]) || 0;
                             }
                        }
                    }
                }

                const total = hadir + sakit + izin + alpha;

                const data = google.visualization.arrayToDataTable([
                    ['Status', 'Jumlah', { role: 'style' }, { role: 'annotation' }],
                    ['Hadir', hadir, '#3B82F6', total > 0 ? `${(hadir/total*100).toFixed(0)}%` : '0%'],
                    ['Sakit', sakit, '#F87171', total > 0 ? `${(sakit/total*100).toFixed(0)}%` : '0%'],
                    ['Izin', izin, '#FBBF24', total > 0 ? `${(izin/total*100).toFixed(0)}%` : '0%'],
                    ['Alpha', alpha, '#9CA3AF', total > 0 ? `${(alpha/total*100).toFixed(0)}%` : '0%']
                ]);

                const isMobile = window.innerWidth < 768;
                const options = {
                    legend: { position: "none" },
                    backgroundColor: 'transparent',
                    chartArea: {
                        width: '85%',
                        height: '80%'
                    },
                    hAxis: {
                        textStyle: { fontSize: isMobile ? 10 : 12 }
                    },
                    vAxis: {
                        gridlines: { color: 'transparent' },
                        format: '0'
                    },
                    annotations: {
                        textStyle: {
                            fontSize: 12,
                            bold: true,
                            color: '#333'
                        },
                        alwaysOutside: true
                    },
                };

                const chart = new google.visualization.ColumnChart(document.getElementById('overall-monthly-pie-chart'));
                chart.draw(data, options);
            }

            function renderOverallDailyTeacherPieChart() {
                let hadir = 0, sakit = 0, izin = 0, alpha = 0;
                
                if (rekapGuru && rekapGuru.length > 1) {
                    const today = new Date();
                    const currentDay = today.getDate();
                    const headers = rekapGuru[0];
                    const dateColumnIndex = headers.indexOf(currentDay) > -1 ? headers.indexOf(currentDay) : headers.indexOf(String(currentDay));
                    
                    if (dateColumnIndex !== -1) {
                        for (let i = 1; i < rekapGuru.length; i++) {
                            const row = rekapGuru[i];
                            const status = String(row[dateColumnIndex] || '').toUpperCase();
                            
                            if (status.startsWith('H')) hadir++;
                            else if (status.startsWith('S')) sakit++;
                            else if (status.startsWith('I')) izin++;
                            else if (status.startsWith('A')) alpha++;
                        }
                    }
                }
                const total = hadir + sakit + izin + alpha;
                
                const data = google.visualization.arrayToDataTable([
                    ['Status', 'Jumlah', { role: 'style' }, { role: 'annotation' }],
                    ['Hadir', hadir, '#34D399', total > 0 ? `${(hadir/total*100).toFixed(0)}%` : '0%'],
                    ['Sakit', sakit, '#F87171', total > 0 ? `${(sakit/total*100).toFixed(0)}%` : '0%'],
                    ['Izin', izin, '#FBBF24', total > 0 ? `${(izin/total*100).toFixed(0)}%` : '0%'],
                    ['Alpha', alpha, '#9CA3AF', total > 0 ? `${(alpha/total*100).toFixed(0)}%` : '0%']
                ]);

                const isMobile = window.innerWidth < 768;
                const options = {
                    legend: { position: "none" },
                    backgroundColor: 'transparent',
                    chartArea: {
                        width: '85%',
                        height: '80%'
                    },
                    hAxis: {
                        textStyle: { fontSize: isMobile ? 10 : 12 }
                    },
                    vAxis: {
                        gridlines: { color: 'transparent' },
                        format: '0'
                    },
                    annotations: {
                        textStyle: {
                            fontSize: 12,
                            bold: true,
                            color: '#333'
                        },
                        alwaysOutside: true
                    },
                };
                
                const chart = new google.visualization.ColumnChart(document.getElementById('overall-daily-teacher-pie-chart'));
                chart.draw(data, options);
            }

            function renderOverallMonthlyTeacherPieChart() {
                let hadir = 0, sakit = 0, izin = 0, alpha = 0;
                
                 if (!rekapGuru || rekapGuru.length < 2) { /* Handle empty data */ } else {
                    const headers = rekapGuru[0];
                    const summaryHIndex = headers.indexOf('Jumlah H');
                    const summarySIndex = headers.indexOf('Jumlah S');
                    const summaryIIndex = headers.indexOf('Jumlah I');
                    const summaryAIndex = headers.indexOf('Jumlah A');
                    
                    if(summaryHIndex > -1){
                        for (let i = 1; i < rekapGuru.length; i++) {
                            const row = rekapGuru[i];
                             if (row[0]) {
                                hadir += parseInt(row[summaryHIndex]) || 0;
                                sakit += parseInt(row[summarySIndex]) || 0;
                                izin += parseInt(row[summaryIIndex]) || 0;
                                alpha += parseInt(row[summaryAIndex]) || 0;
                             }
                        }
                    }
                 }
                const total = hadir + sakit + izin + alpha;

                const data = google.visualization.arrayToDataTable([
                    ['Status', 'Jumlah', { role: 'style' }, { role: 'annotation' }],
                    ['Hadir', hadir, '#3B82F6', total > 0 ? `${(hadir/total*100).toFixed(0)}%` : '0%'],
                    ['Sakit', sakit, '#F87171', total > 0 ? `${(sakit/total*100).toFixed(0)}%` : '0%'],
                    ['Izin', izin, '#FBBF24', total > 0 ? `${(izin/total*100).toFixed(0)}%` : '0%'],
                    ['Alpha', alpha, '#9CA3AF', total > 0 ? `${(alpha/total*100).toFixed(0)}%` : '0%']
                ]);
                
                const isMobile = window.innerWidth < 768;
                const options = {
                    legend: { position: "none" },
                    backgroundColor: 'transparent',
                    chartArea: {
                        width: '85%',
                        height: '80%'
                    },
                    hAxis: {
                        textStyle: { fontSize: isMobile ? 10 : 12 }
                    },
                    vAxis: {
                        gridlines: { color: 'transparent' },
                        format: '0'
                    },
                    annotations: {
                        textStyle: {
                            fontSize: 12,
                            bold: true,
                            color: '#333'
                        },
                        alwaysOutside: true
                    },
                };

                const chart = new google.visualization.ColumnChart(document.getElementById('overall-monthly-teacher-pie-chart'));
                chart.draw(data, options);
            }

            function muatLaporanHarianSiswa(kelas = 'all') {
                const tabelBody = document.querySelector('#tabel-laporan-harian-siswa');
                if(!tabelBody) return;
                tabelBody.innerHTML = '';

                const filteredSiswa = [];
                if (rekapSiswa && rekapSiswa.length > 1) {
                    const today = new Date();
                    const currentDay = today.getDate();
                    const headers = rekapSiswa[0];
                    const dateColumnIndex = headers.indexOf(currentDay) > -1 ? headers.indexOf(currentDay) : headers.indexOf(String(currentDay));
                    
                    const masterSiswaMap = new Map(dataSiswa.map(s => [String(s.nis), s]));
                    
                    if (dateColumnIndex !== -1) {
                        for (let i = 1; i < rekapSiswa.length; i++) {
                            const row = rekapSiswa[i];
                            const status = String(row[dateColumnIndex] || '').toUpperCase();
                            const nis = String(row[0]);
                            const siswaInfo = masterSiswaMap.get(nis);

                            if (siswaInfo && (kelas === 'all' || siswaInfo.kelas === kelas)) {
                                if (status !== 'H' && status !== '-') {
                                    let statusLengkap = 'Alpha';
                                    if(status === 'S') statusLengkap = 'Sakit';
                                    if(status === 'I') statusLengkap = 'Izin';
                                    
                                    filteredSiswa.push({
                                        nama: siswaInfo.nama,
                                        kelas: siswaInfo.kelas,
                                        status: statusLengkap
                                    });
                                }
                            }
                        }
                    }
                }

                if(filteredSiswa.length === 0){
                    tabelBody.innerHTML = `<tr><td colspan="3" class="text-center p-4 text-gray-500">Tidak ada siswa yang tidak hadir hari ini.</td></tr>`;
                    return;
                }

                filteredSiswa.forEach((siswa, index) => {
                    let statusClass = '';
                    switch (siswa.status) {
                        case 'Izin': statusClass = 'bg-yellow-100 text-yellow-800'; break;
                        case 'Sakit': statusClass = 'bg-red-100 text-red-800'; break;
                        case 'Alpha': statusClass = 'bg-gray-100 text-gray-800'; break;
                    }

                    const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-green-50';

                    tabelBody.innerHTML += `
                        <tr class="${rowClass} hover:bg-green-100">
                            <td class="p-3 font-medium text-gray-800">${siswa.nama}</td>
                            <td class="p-3 text-gray-600">${siswa.kelas}</td>
                            <td class="p-3"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${siswa.status}</span></td>
                        </tr>
                    `;
                });
            }

            function muatLaporanHarianGuru() {
                const tabelBody = document.querySelector('#tabel-laporan-harian-guru');
                if(!tabelBody) return;
                tabelBody.innerHTML = '';

                const filteredGuru = [];
                if (rekapGuru && rekapGuru.length > 1) {
                    const today = new Date();
                    const currentDay = today.getDate();
                    const headers = rekapGuru[0];
                    const dateColumnIndex = headers.indexOf(currentDay) > -1 ? headers.indexOf(currentDay) : headers.indexOf(String(currentDay));
                    
                    const masterGuruMap = new Map(dataGuru.map(g => [String(g.id), g]));

                    if (dateColumnIndex !== -1) {
                        for (let i = 1; i < rekapGuru.length; i++) {
                            const row = rekapGuru[i];
                            const status = String(row[dateColumnIndex] || '').toUpperCase();
                            const id = String(row[0]);
                            const guruInfo = masterGuruMap.get(id);

                            if (guruInfo && status !== 'H' && status !== '-') {
                                let statusLengkap = 'Alpha';
                                if(status === 'S') statusLengkap = 'Sakit';
                                if(status === 'I') statusLengkap = 'Izin';
                                
                                filteredGuru.push({
                                    nama: guruInfo.nama,
                                    jabatan: guruInfo.jabatan,
                                    status: statusLengkap
                                });
                            }
                        }
                    }
                }

                 if(filteredGuru.length === 0){
                    tabelBody.innerHTML = `<tr><td colspan="3" class="text-center p-4 text-gray-500">Tidak ada guru yang tidak hadir hari ini.</td></tr>`;
                    return;
                }

                filteredGuru.forEach((guru, index) => {
                    let statusClass = '';
                    switch (guru.status) {
                         case 'Izin': statusClass = 'bg-yellow-100 text-yellow-800'; break;
                        case 'Sakit': statusClass = 'bg-red-100 text-red-800'; break;
                        case 'Alpha': statusClass = 'bg-gray-100 text-gray-800'; break;
                    }

                    const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-green-50';

                    tabelBody.innerHTML += `
                        <tr class="${rowClass} hover:bg-green-100">
                            <td class="p-3 font-medium text-gray-800">${guru.nama}</td>
                            <td class="p-3 text-gray-600">${guru.jabatan}</td>
                            <td class="p-3"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${guru.status}</span></td>
                        </tr>
                    `;
                });
            }
            
            function downloadMonthlyPDF(type) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

                const now = new Date();
                const month = now.toLocaleString('id-ID', { month: 'long' });
                const year = now.getFullYear();
                const daysInMonth = new Date(year, now.getMonth() + 1, 0).getDate();

                const dataRekap = (type === 'siswa') ? rekapSiswa : rekapGuru;
                if (!dataRekap || dataRekap.length < 2) {
                    alert(`Tidak ada data rekap bulanan untuk ${type}.`);
                    return;
                }

                const headers = dataRekap[0];
                const dateHeaders = headers.slice(headers.findIndex(h => h == 1 || h == '1'), headers.indexOf('Jumlah H'));
                const summaryHeaders = ['H', 'S', 'I', 'A'];

                if (type === 'siswa') {
                    const allClasses = [...new Set(dataSiswa.map(s => s.kelas))].sort();
                    allClasses.forEach((kelas, classIndex) => {
                        if (classIndex > 0) doc.addPage('a4', 'landscape');
                        
                        doc.setFontSize(14);
                        doc.text(`Laporan Absensi Bulanan Siswa - Kelas ${kelas}`, 14, 15);
                        doc.setFontSize(10);
                        doc.text(`SMP Diponegoro Sampang - Bulan: ${month} ${year}`, 14, 22);

                        const head = [['No', 'NIS', 'NISN', 'Nama Siswa', ...dateHeaders, ...summaryHeaders]];
                        const body = [];
                        
                        const rekapKelas = dataRekap.slice(1).filter(row => row[3] === kelas);
                        rekapKelas.forEach((row, index) => {
                            const newRow = [
                                index + 1,
                                row[0], // NIS
                                row[1], // NISN
                                row[2], // Nama
                                ...row.slice(4, 4 + daysInMonth), // Data tanggal
                                row[4 + daysInMonth],     // H
                                row[4 + daysInMonth + 1], // S
                                row[4 + daysInMonth + 2], // I
                                row[4 + daysInMonth + 3]  // A
                            ];
                            body.push(newRow);
                        });
                        
                        doc.autoTable({
                            startY: 28, head, body, theme: 'grid',
                            styles: { fontSize: 5, cellPadding: 1, valign: 'middle' },
                            headStyles: { fillColor: [34, 197, 94], textColor: 255, fontStyle: 'bold', halign: 'center' },
                        });
                    });

                } else { // type === 'guru'
                    doc.setFontSize(14);
                    doc.text('Laporan Absensi Bulanan Guru', 14, 15);
                    doc.setFontSize(10);
                    doc.text(`SMP Diponegoro Sampang - Bulan: ${month} ${year}`, 14, 22);

                    const head = [['No', 'Nama Guru', 'Jabatan', ...dateHeaders, ...summaryHeaders]];
                    const body = [];
                    const masterGuruMap = new Map(dataGuru.map(g => [String(g.id), g]));

                    dataRekap.slice(1).forEach((row, index) => {
                        const guruInfo = masterGuruMap.get(String(row[0]));
                        const newRow = [
                            index + 1,
                            row[1], // Nama
                            guruInfo ? guruInfo.jabatan : '', // Jabatan
                            ...row.slice(2, 2 + daysInMonth), // Data tanggal
                            row[2 + daysInMonth],     // H
                            row[2 + daysInMonth + 1], // S
                            row[2 + daysInMonth + 2], // I
                            row[2 + daysInMonth + 3]  // A
                        ];
                        body.push(newRow);
                    });
                    
                    doc.autoTable({
                        startY: 28, head, body, theme: 'grid',
                        styles: { fontSize: 6, cellPadding: 1, valign: 'middle' },
                        headStyles: { fillColor: [34, 197, 94], textColor: 255, fontStyle: 'bold', halign: 'center' },
                    });
                }
                
                const finalY = doc.lastAutoTable.finalY;
                let signatureY = finalY + 10;
                if (signatureY > doc.internal.pageSize.getHeight() - 25) {
                    doc.addPage('a4', 'landscape');
                    signatureY = 20;
                }
                
                const kepalaSekolah = dataGuru.find(g => g.jabatan === 'Kepala Sekolah');
                const namaKepsek = kepalaSekolah ? kepalaSekolah.nama : '.........................';
                
                doc.setFontSize(10);
                doc.text('Mengetahui,', 240, signatureY);
                doc.text('Kepala Sekolah', 240, signatureY + 5);
                doc.text(namaKepsek, 240, signatureY + 25);
                doc.line(240, signatureY + 26, 280, signatureY + 26);

                doc.save(`laporan-${type}-bulanan-${month}-${year}.pdf`);
            }
            
            // Resize charts on window resize
            window.addEventListener('resize', () => {
                 const visiblePage = document.querySelector('.page:not(.hidden)');
                if (visiblePage) {
                    const pageId = visiblePage.id.replace('-page', '');
                    renderChartsForPage(pageId);
                }
            });

            // Inisialisasi aplikasi saat DOM siap
            init();
        });
    </script>
</body>
</html>